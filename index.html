<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eva K-Pop Tour - Official App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@400;600;800&display=swap');
        
        :root {
            --bg-url: url('https://images.tcdn.com.br/img/img_prod/1129828/k_pop_hunters_volume_1_e_2_3127_1_15d868953923485f762744d567118833.jpg');
            --kpop-pink: #ff0080;
            --kpop-purple: #7928ca;
        }

        body { 
            font-family: 'Archivo', sans-serif; 
            background-color: #0b0b0b;
            color: white;
            margin: 0;
            background-image: var(--bg-url);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.65), rgba(0,0,0,0.92));
            z-index: 0;
            pointer-events: none;
        }

        #app { position: relative; z-index: 1; }
        .font-header { font-family: 'Archivo Black', sans-serif; text-transform: uppercase; font-style: italic; }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .kpop-gradient { 
            background: linear-gradient(135deg, var(--kpop-pink) 0%, var(--kpop-purple) 100%); 
        }

        .tab-active { 
            border-bottom: 4px solid var(--kpop-pink); 
            color: var(--kpop-pink); 
            opacity: 1 !important; 
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .animate-marquee { display: inline-flex; animation: marquee 15s linear infinite; }
        
        .btn-press:active { transform: scale(0.9); }
    </style>
</head>
<body class="pb-20">
    <div class="overlay"></div>

    <div id="app">
        <!-- HEADER -->
        <header class="p-6 kpop-gradient sticky top-0 z-50 shadow-2xl">
            <div class="flex justify-between items-end max-w-4xl mx-auto">
                <div>
                    <h1 class="font-header text-3xl italic tracking-tighter leading-none">Eva World Tour</h1>
                    <p id="status-text" class="text-[10px] font-black opacity-80 tracking-[0.3em] uppercase mt-1">Sincronizando Staff...</p>
                </div>
                <div id="display-date" class="text-xs font-black opacity-90 uppercase italic border-l border-white/30 pl-3"></div>
            </div>
        </header>

        <!-- MARQUEE -->
        <div class="bg-white text-black py-1 overflow-hidden whitespace-nowrap z-40 relative">
            <div class="animate-marquee flex items-center">
                <span class="mx-4 font-black italic text-[10px] uppercase tracking-widest">WORLD TOUR 2026</span>
                <span class="text-pink-600">âœ¦</span>
                <span class="mx-4 font-black italic text-[10px] uppercase tracking-widest">LIVE IN SEOUL</span>
                <span class="text-pink-600">âœ¦</span>
                <span class="mx-4 font-black italic text-[10px] uppercase tracking-widest">EVA K-POP CHALLENGE</span>
                <span class="text-pink-600">âœ¦</span>
                <span class="mx-4 font-black italic text-[10px] uppercase tracking-widest">WORLD TOUR 2026</span>
                <span class="text-pink-600">âœ¦</span>
            </div>
        </div>

        <!-- NAVIGATION -->
        <nav class="flex justify-around bg-black/80 border-b border-white/10 sticky top-[84px] z-40 backdrop-blur-md">
            <button onclick="window.App.setTab('daily')" id="tab-daily" class="py-4 px-4 text-[11px] font-black uppercase tracking-widest tab-active transition-all">Misiones</button>
            <button onclick="window.App.setTab('rewards')" id="tab-rewards" class="py-4 px-4 text-[11px] font-black uppercase tracking-widest opacity-40 transition-all">Premios</button>
            <button onclick="window.App.setTab('history')" id="tab-history" class="py-4 px-4 text-[11px] font-black uppercase tracking-widest opacity-40 transition-all">Historial</button>
        </nav>

        <main class="p-4 max-w-xl mx-auto">
            <!-- PANTALLA DE CARGA -->
            <div id="loader" class="flex flex-col items-center justify-center py-32 space-y-4">
                <div class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-[10px] font-black text-pink-500 uppercase tracking-[0.3em]">Cargando Datos del Tour...</p>
            </div>
            
            <div id="content" class="hidden"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // CONFIGURACIÃ“N DINÃMICA DEL ENTORNO
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'eva-kpop-v2';

        const App = {
            currentTab: 'daily',
            user: null,
            data: { today: {}, allHistory: [] },
            
            tasks: [
                { id: 't1', label: 'Hacer la cama', icon: 'ðŸ›ï¸', max: 1, pts: 5 },
                { id: 't2', label: 'Lavar Dientes', icon: 'ðŸª¥', max: 6, pts: 2 },
                { id: 't3', label: 'Dormir sola', icon: 'ðŸŒ™', max: 1, pts: 10 },
                { id: 't4', label: 'BaÃ±arse sola', icon: 'ðŸš¿', max: 1, pts: 5 },
                { id: 't5', label: 'Vestirse sola', icon: 'ðŸ‘—', max: 1, pts: 5 },
                { id: 't6', label: 'Leer Libro', icon: 'ðŸ“š', max: 6, pts: 4 },
                { id: 't7', label: 'Tarea / Dibujo', icon: 'ðŸŽ¨', max: 4, pts: 3 },
                { id: 't8', label: 'Comida Sana', icon: 'ðŸŽ', max: 5, pts: 2 },
                { id: 'v1', label: 'Sinceridad', icon: 'ðŸ˜‡', max: 1, pts: 5 },
                { id: 'v2', label: 'Hablar suave', icon: 'ðŸ¤«', max: 5, pts: 3 }
            ],

            rewards: [
                { id: 'r1', label: 'Stickers K-Pop', pts: 50, icon: 'ðŸ·ï¸' },
                { id: 'r2', label: '30 min Tablet', pts: 150, icon: 'ðŸ“±' },
                { id: 'r3', label: 'Cromos Blackpink', pts: 400, icon: 'ðŸ“¸' },
                { id: 'r4', label: 'Ãlbum NewJeans', pts: 1000, icon: 'ðŸ’¿' },
                { id: 'r5', label: 'Lightstick Oficial', pts: 2500, icon: 'ðŸª„' }
            ],

            async init() {
                // Reloj
                document.getElementById('display-date').innerText = new Date().toLocaleDateString('es-ES', { 
                    weekday: 'short', day: 'numeric', month: 'short' 
                });

                // AutenticaciÃ³n obligatoria antes de cualquier consulta (Regla 3)
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (err) {
                    console.error("Auth Error:", err);
                    document.getElementById('status-text').innerText = "ERROR DE ACCESO";
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.user = user;
                        document.getElementById('status-text').innerText = "STAFF AUTORIZADO";
                        this.startListeners();
                    }
                });
            },

            startListeners() {
                if (!this.user) return;
                const todayId = new Date().toLocaleDateString('en-CA'); 
                
                // Ruta estricta de Firestore (Regla 1)
                const todayRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily', todayId);
                const histRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily');

                // Listener Hoy
                onSnapshot(todayRef, (snap) => {
                    this.data.today = snap.exists() ? (snap.data().points || {}) : {};
                    this.render();
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('content').classList.remove('hidden');
                }, (err) => console.error("Error Hoy:", err));

                // Listener Historial
                onSnapshot(histRef, (snap) => {
                    this.data.allHistory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.render();
                }, (err) => console.error("Error Historial:", err));
            },

            setTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('nav button').forEach(b => {
                    const isActive = b.id === `tab-${tab}`;
                    b.classList.toggle('tab-active', isActive);
                    b.classList.toggle('opacity-40', !isActive);
                });
                this.render();
            },

            async updatePoint(taskId, delta, max) {
                if (!this.user) return;
                
                let current = Number(this.data.today[taskId] || 0);
                let newVal = Math.max(0, Math.min(max, current + delta));
                
                const todayId = new Date().toLocaleDateString('en-CA');
                const todayRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily', todayId);

                try {
                    await setDoc(todayRef, {
                        points: { ...this.data.today, [taskId]: newVal },
                        date: todayId,
                        lastUpdate: Date.now()
                    }, { merge: true });
                } catch (err) {
                    console.error("Save Error:", err);
                }
            },

            render() {
                const el = document.getElementById('content');
                if (!el) return;

                // CÃ¡lculo de puntos acumulados totales
                const totalPoints = this.data.allHistory.reduce((sum, day) => {
                    const ptsMap = day.points || {};
                    return sum + Object.entries(ptsMap).reduce((dSum, [tid, count]) => {
                        const task = this.tasks.find(t => t.id === tid);
                        return dSum + (count * (task ? task.pts : 0));
                    }, 0);
                }, 0);

                if (this.currentTab === 'daily') {
                    const todayPoints = Object.entries(this.data.today).reduce((acc, [tid, count]) => {
                        const task = this.tasks.find(t => t.id === tid);
                        return acc + (count * (task ? task.pts : 0));
                    }, 0);

                    el.innerHTML = `
                        <div class="text-center py-8 mb-4">
                            <p class="text-[10px] font-black tracking-[0.4em] text-pink-500 uppercase italic mb-1">Puntos de Hoy</p>
                            <h2 class="text-8xl font-header italic tracking-tighter drop-shadow-lg leading-none">${todayPoints}</h2>
                        </div>
                        <div class="grid gap-3 pb-24">
                            ${this.tasks.map(t => {
                                const count = this.data.today[t.id] || 0;
                                return `
                                    <div class="glass p-4 rounded-[2rem] flex items-center justify-between transition-all active:bg-white/10">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 glass rounded-2xl flex items-center justify-center text-2xl">${t.icon}</div>
                                            <div>
                                                <h4 class="font-black text-sm uppercase italic leading-none">${t.label}</h4>
                                                <p class="text-[9px] font-bold text-pink-400 mt-1 uppercase tracking-widest">${t.pts} PTS</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button onclick="window.App.updatePoint('${t.id}', -1, ${t.max})" class="btn-press w-10 h-10 rounded-full glass flex items-center justify-center font-black text-xl">-</button>
                                            <span class="text-2xl font-header italic w-6 text-center">${count}</span>
                                            <button onclick="window.App.updatePoint('${t.id}', 1, ${t.max})" class="btn-press w-12 h-12 kpop-gradient rounded-full flex items-center justify-center font-black text-2xl shadow-lg">+</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else if (this.currentTab === 'rewards') {
                    el.innerHTML = `
                        <div class="glass rounded-[2rem] p-8 mb-8 text-center border-pink-500/30">
                            <p class="text-[10px] font-black text-pink-500 uppercase tracking-[0.4em] mb-1 italic">Tour Total</p>
                            <h2 class="text-7xl font-header italic tracking-tighter">${totalPoints}</h2>
                        </div>
                        <div class="grid gap-4 pb-24">
                            ${this.rewards.map(r => {
                                const prog = Math.min(100, (totalPoints / r.pts) * 100);
                                return `
                                    <div class="glass p-5 rounded-3xl flex items-center justify-between relative overflow-hidden">
                                        <div class="absolute top-0 left-0 h-full bg-pink-500/20 transition-all duration-1000" style="width: ${prog}%"></div>
                                        <div class="flex items-center gap-4 relative z-10">
                                            <span class="text-4xl filter drop-shadow-md">${r.icon}</span>
                                            <div>
                                                <h4 class="font-black text-sm uppercase italic leading-none">${r.label}</h4>
                                                <p class="text-[10px] font-black text-pink-400 mt-1 tracking-widest">${r.pts} PTS</p>
                                            </div>
                                        </div>
                                        <div class="relative z-10 font-header italic text-xl ${prog >= 100 ? 'text-green-400' : 'opacity-30'}">
                                            ${Math.floor(prog)}%
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    el.innerHTML = `
                        <div class="space-y-3 py-4 pb-24">
                            ${this.data.allHistory.sort((a,b)=>b.id.localeCompare(a.id)).map(day => {
                                const dayTotal = Object.entries(day.points || {}).reduce((acc, [tid, count]) => {
                                    const task = this.tasks.find(t => t.id === tid);
                                    return acc + (count * (task ? task.pts : 0));
                                }, 0);
                                return `
                                    <div class="glass p-5 rounded-2xl flex justify-between items-center border-l-4 border-pink-500">
                                        <span class="text-[10px] font-black uppercase opacity-60 tracking-widest">${day.id}</span>
                                        <span class="font-header text-pink-500 italic text-xl">${dayTotal} PTS</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            }
        };

        window.App = App;
        window.onload = () => App.init();
    </script>
</body>
</html>
