<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eva K-Pop Tour - Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Archivo', sans-serif; 
            background-color: #0b0b0b;
            color: white;
            margin: 0;
            padding: 0;
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1546707012-c46675f12716?q=80&w=2069&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .font-header { font-family: 'Archivo Black', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .kpop-gradient { background: linear-gradient(135deg, #ff0080 0%, #7928ca 100%); }
        .tab-active { border-bottom: 4px solid #ff0080; color: #ff0080; opacity: 1 !important; }
        .btn-press:active { transform: scale(0.95); }
    </style>
</head>
<body class="pb-24">
    <div id="app">
        <!-- Encabezado -->
        <header class="p-6 kpop-gradient sticky top-0 z-50 shadow-2xl">
            <div class="flex justify-between items-center max-w-4xl mx-auto">
                <div>
                    <h1 class="font-header text-2xl italic tracking-tighter uppercase">Eva World Tour</h1>
                    <p id="auth-status" class="text-[10px] font-bold opacity-80 tracking-widest uppercase text-yellow-400">Iniciando sesi√≥n...</p>
                </div>
                <div id="user-display" class="hidden text-right">
                    <span class="text-[9px] block opacity-60 uppercase font-black">ID de Artista</span>
                    <span id="uid-text" class="text-[10px] font-mono bg-black/30 px-2 py-1 rounded">---</span>
                </div>
            </div>
        </header>

        <!-- Navegaci√≥n -->
        <nav class="flex justify-around bg-black/80 border-b border-white/10 sticky top-[76px] z-40 backdrop-blur-md">
            <button onclick="setTab('daily')" id="tab-daily" class="py-4 px-6 text-xs font-black uppercase tracking-widest tab-active">Misiones</button>
            <button onclick="setTab('rewards')" id="tab-rewards" class="py-4 px-6 text-xs font-black uppercase tracking-widest opacity-50">Premios</button>
            <button onclick="setTab('history')" id="tab-history" class="py-4 px-6 text-xs font-black uppercase tracking-widest opacity-50">Historial</button>
        </nav>

        <main class="p-4 max-w-4xl mx-auto min-h-[60vh]">
            <!-- Mensajes de Error/Diagn√≥stico -->
            <div id="error-console" class="hidden mb-6 p-4 bg-red-900/40 border border-red-500 rounded-2xl">
                <h3 class="text-red-400 font-bold text-xs uppercase mb-2">Error de Conexi√≥n Detectado</h3>
                <p id="error-message" class="text-sm opacity-90"></p>
                <button onclick="location.reload()" class="mt-3 text-[10px] font-bold underline uppercase">Reintentar Conexi√≥n</button>
            </div>

            <div id="loader" class="flex flex-col items-center justify-center py-32 space-y-4">
                <div class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-sm font-bold text-pink-400 animate-pulse uppercase">Cargando Datos de la Gira...</p>
            </div>

            <div id="content" class="hidden"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // CONFIGURACI√ìN (Aseg√∫rate de que el API Key sea el de tu consola)
        const firebaseConfig = {
            apiKey: "AIzaSyBE3mn9a-hgJjr3zRI_fftNfI4jfrCllQc", 
            authDomain: "eva-kpop-tour.firebaseapp.com",
            projectId: "eva-kpop-tour",
            storageBucket: "eva-kpop-tour.firebasestorage.app",
            messagingSenderId: "49327968177",
            appId: "1:49327968177:web:647c232224aa288f3c7790"
        };

        // Variables de entorno proporcionadas por la plataforma
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'eva-kpop-tour-v2';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, currentUser = null;
        let localData = { today: {}, history: [] };

        const tasks = [
            { id: 't1', label: 'Hacer la cama', icon: 'üõèÔ∏è', max: 1 },
            { id: 't2', label: 'Dientes', icon: 'ü™•', max: 6 },
            { id: 't3', label: 'Dormir sola', icon: 'üåô', max: 1 },
            { id: 't4', label: 'Ba√±arse sola', icon: 'üöø', max: 1 },
            { id: 't5', label: 'Vestirse sola', icon: 'üëó', max: 1 },
            { id: 'v1', label: 'No enga√±ar', icon: 'üòá', max: 10 },
            { id: 'v2', label: 'No gritar', icon: 'ü§´', max: 3 }
        ];

        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Autenticaci√≥n (Prioridad seg√∫n Regla 3)
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('auth-status').innerText = "SHOW EN VIVO";
                        document.getElementById('auth-status').classList.replace('text-yellow-400', 'text-green-400');
                        document.getElementById('user-display').classList.remove('hidden');
                        document.getElementById('uid-text').innerText = user.uid;
                        startSync();
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('error-console').classList.remove('hidden');
                document.getElementById('error-message').innerText = `Error de API Key: ${error.message}. Verifica que el dominio est√© autorizado en Firebase Console.`;
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function startSync() {
            if (!currentUser) return;
            const todayId = new Date().toLocaleDateString('en-CA');
            
            // Ruta p√∫blica seg√∫n Regla 1
            const dailyDoc = doc(db, 'artifacts', appId, 'public', 'data', 'daily', todayId);

            onSnapshot(dailyDoc, (snap) => {
                localData.today = snap.exists() ? (snap.data().points || {}) : {};
                render();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
            }, (err) => {
                document.getElementById('error-console').classList.remove('hidden');
                document.getElementById('error-message').innerText = `Error de Firestore: ${err.message}. Revisa las reglas de seguridad.`;
            });
        }

        window.addPoint = async (taskId, delta, max) => {
            if (!currentUser) return;
            const todayId = new Date().toLocaleDateString('en-CA');
            let current = Number(localData.today[taskId] || 0);
            let newVal = Math.max(0, Math.min(max, current + delta));

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily', todayId), {
                    points: { ...localData.today, [taskId]: newVal },
                    lastUpdate: new Date().toISOString()
                }, { merge: true });
            } catch (e) {
                console.error("Error al guardar:", e);
            }
        };

        window.setTab = (tab) => {
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.toggle('tab-active', b.id === `tab-${tab}`);
                b.classList.toggle('opacity-50', b.id !== `tab-${tab}`);
            });
            render(tab);
        };

        function render(tab = 'daily') {
            const el = document.getElementById('content');
            if (tab === 'daily') {
                const total = Object.values(localData.today).reduce((a, b) => a + b, 0);
                el.innerHTML = `
                    <div class="text-center py-8 mb-4">
                        <p class="text-[10px] font-black tracking-[0.3em] text-pink-500 uppercase">Puntos de Hoy</p>
                        <h2 class="text-8xl font-header italic">${total}</h2>
                    </div>
                    <div class="grid gap-3">
                        ${tasks.map(t => {
                            const p = localData.today[t.id] || 0;
                            return `
                                <div class="glass p-4 rounded-[2rem] flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <span class="text-3xl">${t.icon}</span>
                                        <div>
                                            <h4 class="font-bold text-sm uppercase italic leading-none">${t.label}</h4>
                                            <p class="text-[9px] opacity-60 font-bold mt-1 uppercase">M√°ximo: ${t.max}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <button onclick="addPoint('${t.id}', -1, ${t.max})" class="btn-press w-10 h-10 rounded-full flex items-center justify-center bg-white/10 font-black">-</button>
                                        <span class="text-2xl font-header w-6 text-center">${p}</span>
                                        <button onclick="addPoint('${t.id}', 1, ${t.max})" class="btn-press w-12 h-12 kpop-gradient rounded-full flex items-center justify-center font-black text-2xl shadow-lg">+</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tab === 'rewards') {
                el.innerHTML = `<div class="py-20 text-center opacity-40 uppercase font-black tracking-widest italic">Pr√≥ximamente en la gira...</div>`;
            }
        }

        init();
    </script>
</body>
</html>
