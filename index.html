<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eva K-Pop Tour - Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@400;600;800&display=swap');
        
        :root {
            --bg-url: url('https://images.tcdn.com.br/img/img_prod/1129828/k_pop_hunters_volume_1_e_2_3127_1_15d868953923485f762744d567118833.jpg');
        }

        body { 
            font-family: 'Archivo', sans-serif; 
            background-color: #0b0b0b;
            color: white;
            margin: 0;
            padding: 0;
            background-image: var(--bg-url);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); 
            z-index: 0;
            pointer-events: none;
        }

        #app { position: relative; z-index: 1; }
        .font-header { font-family: 'Archivo Black', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .kpop-gradient { background: linear-gradient(135deg, #ff0080 0%, #7928ca 100%); }
        .tab-active { border-bottom: 4px solid #ff0080; color: #ff0080; opacity: 1 !important; }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .animate-marquee { display: inline-flex; animation: marquee 20s linear infinite; }
        .btn-press:active { transform: scale(0.92); }
        .btn-minus { background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.6); color: #ff5f5f; }
    </style>
</head>
<body class="pb-24">
    <div class="overlay"></div>

    <div id="app">
        <header class="p-6 kpop-gradient sticky top-0 z-50 shadow-2xl">
            <div class="flex justify-between items-center max-w-4xl mx-auto">
                <div>
                    <h1 class="font-header text-2xl italic tracking-tighter uppercase">Eva World Tour</h1>
                    <p id="status-text" class="text-[10px] font-bold opacity-80 tracking-widest uppercase">Conectando...</p>
                </div>
                <div class="text-right">
                    <span id="display-date" class="text-xs font-black opacity-70 uppercase tracking-tighter italic">Cargando fecha...</span>
                </div>
            </div>
        </header>

        <div class="bg-white text-black py-2 overflow-hidden whitespace-nowrap border-b border-white/20">
            <div class="animate-marquee flex items-center">
                <span class="mx-4 font-black italic text-xs uppercase tracking-widest">EVA K-POP CHALLENGE 2026</span>
                <span class="mx-4 text-pink-600">âœ¦</span>
                <span class="mx-4 font-black italic text-xs uppercase tracking-widest">EVA K-POP CHALLENGE 2026</span>
                <span class="mx-4 text-pink-600">âœ¦</span>
                <span class="mx-4 font-black italic text-xs uppercase tracking-widest">EVA K-POP CHALLENGE 2026</span>
                <span class="mx-4 text-pink-600">âœ¦</span>
            </div>
        </div>

        <nav class="flex justify-around bg-black/60 border-b border-white/10 sticky top-[76px] z-40 backdrop-blur-md">
            <button onclick="window.App.setTab('daily')" id="tab-daily" class="py-4 px-6 text-xs font-black uppercase tracking-widest tab-active">Misiones</button>
            <button onclick="window.App.setTab('rewards')" id="tab-rewards" class="py-4 px-6 text-xs font-black uppercase tracking-widest opacity-50">Premios</button>
            <button onclick="window.App.setTab('history')" id="tab-history" class="py-4 px-6 text-xs font-black uppercase tracking-widest opacity-50">Historial</button>
        </nav>

        <main class="p-4 max-w-4xl mx-auto min-h-[60vh]">
            <div id="loader" class="flex flex-col items-center justify-center py-32 space-y-4">
                <div class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                <p id="loader-text" class="text-sm font-bold text-pink-400 animate-pulse uppercase">Cargando Tour...</p>
            </div>
            <div id="content" class="hidden"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // CONFIGURACIÃ“N DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBE3mn9a-hgJjr3zRI_fftNfI4jfrCllQc",
            authDomain: "eva-kpop-tour.firebaseapp.com",
            projectId: "eva-kpop-tour",
            storageBucket: "eva-kpop-tour.firebasestorage.app",
            messagingSenderId: "49327968177",
            appId: "1:49327968177:web:647c232224aa288f3c7790"
        };

        let app, db, auth;
        const APP_ID = 'eva-tour-v1';

        const App = {
            currentTab: 'daily',
            user: null,
            data: { today: {}, allHistory: [] },
            
            tasks: [
                { id: 't1', label: 'Hacer la cama', icon: 'ðŸ›ï¸', max: 1 },
                { id: 't2', label: 'Dientes', icon: 'ðŸª¥', max: 6 },
                { id: 't3', label: 'Dormir sola', icon: 'ðŸŒ™', max: 1 },
                { id: 't4', label: 'BaÃ±arse sola', icon: 'ðŸš¿', max: 1 },
                { id: 't5', label: 'Vestirse sola', icon: 'ðŸ‘—', max: 1 },
                { id: 't6', label: 'Leer', icon: 'ðŸ“š', max: 6 },
                { id: 't7', label: 'Tarea', icon: 'ðŸ“', max: 4 },
                { id: 't8', label: 'Comida Balanceada', icon: 'ðŸŽ', max: 5 },
                { id: 'v1', label: 'No engaÃ±ar', icon: 'ðŸ˜‡', max: 10 },
                { id: 'v2', label: 'No gritar / imponerse', icon: 'ðŸ¤«', max: 3 },
                { id: 'v3', label: 'Respetar mayores', icon: 'ðŸ¤', max: 6 }
            ],

            rewards: [
                { id: 'r1', label: 'Postre a elecciÃ³n', pts: 150, icon: 'ðŸ¨', type: 'Semanal' },
                { id: 'r2', label: '30 min TecnologÃ­a', pts: 250, icon: 'ðŸ“±', type: 'Semanal' },
                { id: 'r3', label: 'Regalo Sorpresa', pts: 800, icon: 'ðŸŽ', type: 'Mensual' },
                { id: 'r4', label: 'Salida Especial', pts: 1200, icon: 'ðŸŽ¡', type: 'Mensual' },
                { id: 'r5', label: 'Paseo + Regalo', pts: 2000, icon: 'ðŸ’Ž', type: 'Mensual' }
            ],

            async init() {
                try {
                    const dateEl = document.getElementById('display-date');
                    if(dateEl) dateEl.innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            this.user = user;
                            document.getElementById('status-text').innerText = "TOUR ONLINE";
                            this.startListeners();
                        } else {
                            try {
                                await signInAnonymously(auth);
                            } catch (e) {
                                console.error("Error de Auth:", e);
                                this.showError("Error de ConexiÃ³n: Revisa tu API Key en la consola de Firebase.");
                            }
                        }
                    });
                } catch (error) {
                    this.showError("Error de inicializaciÃ³n.");
                }
            },

            showError(msg) {
                const status = document.getElementById('status-text');
                const loaderText = document.getElementById('loader-text');
                if(status) status.innerText = "ERROR";
                if(loaderText) {
                    loaderText.innerText = msg;
                    loaderText.classList.remove('text-pink-400');
                    loaderText.classList.add('text-red-500');
                }
            },

            startListeners() {
                const todayId = new Date().toLocaleDateString('en-CA');
                
                onSnapshot(doc(db, 'artifacts', APP_ID, 'public', 'data', 'daily', todayId), (snap) => {
                    this.data.today = snap.exists() ? (snap.data().points || {}) : {};
                    this.render();
                    document.getElementById('loader')?.classList.add('hidden');
                    document.getElementById('content')?.classList.remove('hidden');
                }, (err) => {
                    console.error("Firestore Error:", err);
                    this.showError("Error de permisos en la base de datos.");
                });

                onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily'), (snap) => {
                    this.data.allHistory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.render();
                });
            },

            setTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('nav button').forEach(b => {
                    b.classList.toggle('tab-active', b.id === `tab-${tab}`);
                    b.classList.toggle('opacity-50', b.id !== `tab-${tab}`);
                });
                this.render();
            },

            async addPoint(taskId, delta, max) {
                if (!this.user) return;
                let current = Number(this.data.today[taskId] || 0);
                let newVal = current + delta;
                if (max !== null && newVal > max) newVal = max;
                if (newVal < -50) newVal = -50;

                const todayId = new Date().toLocaleDateString('en-CA');
                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'daily', todayId), { 
                        points: { ...this.data.today, [taskId]: newVal },
                        date: todayId
                    }, { merge: true });
                } catch (e) {
                    console.error("Error guardando:", e);
                }
            },

            render() {
                const el = document.getElementById('content');
                if (!el) return;

                if (this.currentTab === 'daily') {
                    const totalToday = Object.values(this.data.today).reduce((a, b) => a + (Number(b) || 0), 0);
                    el.innerHTML = `
                        <div class="text-center py-8 mb-4">
                            <p class="text-[10px] font-black tracking-[0.3em] text-pink-500 uppercase">Puntos del Show</p>
                            <h2 class="text-8xl font-header italic drop-shadow-2xl">${totalToday}</h2>
                        </div>
                        <div class="grid gap-3 mb-10">
                            ${this.tasks.map(t => {
                                const p = this.data.today[t.id] || 0;
                                return `
                                    <div class="glass p-4 rounded-[2rem] flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <span class="text-3xl">${t.icon}</span>
                                            <div>
                                                <h4 class="font-bold text-sm uppercase italic leading-none">${t.label}</h4>
                                                <p class="text-[9px] opacity-60 font-bold mt-1 uppercase">Meta: ${t.max}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button onclick="window.App.addPoint('${t.id}', -1, ${t.max})" class="btn-press btn-minus w-10 h-10 rounded-full flex items-center justify-center font-black text-xl">-</button>
                                            <span class="text-2xl font-header w-6 text-center">${p}</span>
                                            <button onclick="window.App.addPoint('${t.id}', 1, ${t.max})" class="btn-press w-12 h-12 kpop-gradient rounded-full flex items-center justify-center font-black text-2xl shadow-lg">+</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else if (this.currentTab === 'rewards') {
                    const total = this.data.allHistory.reduce((sum, day) => sum + Object.values(day.points || {}).reduce((a, b) => a + (Number(b) || 0), 0), 0);
                    el.innerHTML = `
                        <div class="glass rounded-[2.5rem] p-8 mb-8 text-center border-pink-500/30">
                            <p class="text-[10px] font-black text-pink-500 uppercase tracking-[0.3em] mb-2">Total de la Gira</p>
                            <h2 class="text-7xl font-header italic">${total}</h2>
                        </div>
                        <div class="grid gap-4 pb-10">
                            ${this.rewards.map(r => {
                                const prog = Math.min(100, (total / r.pts) * 100);
                                return `
                                    <div class="glass p-5 rounded-3xl flex items-center justify-between border-white/10 relative overflow-hidden">
                                        <div class="absolute top-0 left-0 h-full bg-pink-500/10" style="width: ${prog}%"></div>
                                        <div class="flex items-center gap-4 relative z-10">
                                            <span class="text-4xl">${r.icon}</span>
                                            <div>
                                                <span class="text-[8px] font-black uppercase px-2 py-0.5 rounded-full ${r.type === 'Semanal' ? 'bg-blue-600' : 'bg-purple-600'} text-white">${r.type}</span>
                                                <h4 class="font-bold text-sm uppercase italic mt-1">${r.label}</h4>
                                                <p class="text-[10px] font-bold text-pink-400">${r.pts} PTS</p>
                                            </div>
                                        </div>
                                        <div class="relative z-10 font-header ${prog >= 100 ? 'text-green-400' : 'opacity-30'} text-xl">${Math.floor(prog)}%</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    el.innerHTML = `<div class="grid gap-3">
                        ${this.data.allHistory.sort((a,b)=>b.id.localeCompare(a.id)).map(day => `
                            <div class="glass p-5 rounded-2xl flex justify-between items-center">
                                <span class="text-xs font-black uppercase opacity-60 italic">${day.id}</span>
                                <span class="font-header text-pink-500">${Object.values(day.points || {}).reduce((a,b)=>a+b,0)} PTS</span>
                            </div>
                        `).join('')}
                    </div>`;
                }
            }
        };

        window.App = App;
        window.onload = () => App.init();
    </script>
</body>
</html>
