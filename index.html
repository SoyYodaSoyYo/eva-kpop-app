<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eva Alem√°n - K-Pop Hunters World Tour</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@300;500;900&display=swap');
        
        :root {
            --kpop-pink: #ec4899;
            --kpop-purple: #7c3aed;
        }

        body { 
            font-family: 'Archivo Black', sans-serif; 
            background-color: #000;
            color: white;
            margin: 0;
            overflow-x: hidden;
        }

        .font-archivo { font-family: 'Archivo', sans-serif; }
        .font-medium { font-family: 'Archivo', sans-serif; font-weight: 500; }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .animate-marquee {
            display: inline-flex;
            animation: marquee 30s linear infinite;
        }

        .glass-card {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(12px);
            border: 4px solid rgba(255, 255, 255, 0.1);
        }

        .shadow-3xl { 
            box-shadow: 0 40px 100px -20px rgba(124, 58, 237, 0.4); 
        }

        .btn-action {
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
        }

        .btn-action:active {
            transform: scale(0.95);
        }

        .gemini-gradient {
            background: linear-gradient(90deg, #4285f4, #9b72cb, #d96570);
        }
    </style>
</head>
<body>
    <!-- BACKGROUND -->
    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://images.tcdn.com.br/img/img_prod/1129828/k_pop_hunters_volume_1_e_2_3127_1_15d868953923485f762744d567118833.jpg')"></div>
    <div id="bg-overlay" class="fixed inset-0 z-0 backdrop-blur-[4px] transition-colors duration-700 bg-black/75"></div>

    <div id="app-root" class="relative z-10 min-h-screen pb-20">
        <!-- Loader inicial -->
        <div class="flex flex-col items-center justify-center h-screen gap-6">
            <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-pink-500"></div>
            <p class="text-2xl font-black italic animate-pulse">PREPARANDO EL ESCENARIO...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Configuraci√≥n basada en tu captura de pantalla de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBE3mn9a-hgJjr3zRI_fftNfI4jfrC1lQc",
            authDomain: "eva-kpop-tour.firebaseapp.com",
            projectId: "eva-kpop-tour",
            storageBucket: "eva-kpop-tour.firebasestorage.app",
            messagingSenderId: "49327968177",
            appId: "1:49327968177:web:647c232224aa200f3c7790",
            measurementId: "G-QF7L984HZ5"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'eva-kpop-tour'; 

        window.KPopApp = {
            state: {
                taskPoints: {},
                history: {},
                user: null,
                viewingDate: null,
                todayDay: new Date().getDate(),
                currentYear: new Date().getFullYear(),
                currentMonth: new Date().getMonth() + 1
            },

            tasks: [
                { id: 'h1', label: 'Hacer la cama', emoji: 'üõèÔ∏è', max: 1 },
                { id: 'h2', label: 'Dientes (x6)', emoji: 'ü™•', max: 6 },
                { id: 'h3', label: 'Dormir sola', emoji: 'üåô', max: 1 },
                { id: 'h4', label: 'Ba√±arse sola', emoji: 'üöø', max: 1 },
                { id: 'h5', label: 'Vestirse sola', emoji: 'üëó', max: 1 },
                { id: 'h6', label: 'Espacio ordenado', emoji: 'üß∏', max: 1 },
                { id: 'h7', label: 'Crear algo', emoji: 'üé®', max: 4 },
                { id: 'h8', label: 'Leer', emoji: 'üìö', max: 5 },
                { id: 'h9', label: 'Tarea', emoji: 'üìù', max: 10 },
                { id: 's1', label: 'Balance con comida', emoji: 'üçé', max: 5 },
                { id: 's2', label: 'Tiempo de pantalla', emoji: 'üì±', max: 5 },
                { id: 'v1', label: 'No enga√±ar', emoji: 'üòá', max: 30 },
                { id: 'v2', label: 'No gritar a los dem√°s', emoji: 'ü§´', max: 10 },
                { id: 'v3', label: 'Respetar a mayores', emoji: 'ü§ù', max: 20 }
            ],

            rewards: [
                { id: 'r1', type: 'semanal', label: 'Postre especial', cost: 150, emoji: 'üçø', color: 'from-blue-400 to-blue-600' },
                { id: 'r2', type: 'semanal', label: 'Helado', cost: 200, emoji: 'üç¶', color: 'from-pink-400 to-pink-600' },
                { id: 'r3', type: 'semanal', label: '30 min Pantalla', cost: 250, emoji: 'üéÆ', color: 'from-purple-400 to-purple-600' },
                { id: 'r4', type: 'mensual', label: 'Regalo Sorpresa', cost: 800, emoji: 'üéÅ', color: 'from-yellow-400 to-orange-600' },
                { id: 'r5', type: 'mensual', label: 'Paseo especial', cost: 1200, emoji: 'üßñ‚Äç‚ôÄÔ∏è', color: 'from-teal-400 to-teal-600' },
                { id: 'r6', type: 'mensual', label: 'Juguete o dinero', cost: 2000, emoji: 'üé´', color: 'from-red-400 to-red-600' }
            ],

            async init() {
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            await signInAnonymously(auth);
                        } catch (e) {
                            console.error("Error en Auth An√≥nima:", e);
                            document.getElementById('app-root').innerHTML = `
                                <div class="p-10 text-center">
                                    <h2 class="text-2xl font-bold text-red-500">Error de Conexi√≥n</h2>
                                    <p>Aseg√∫rate de haber activado "Acceso An√≥nimo" en Firebase Auth.</p>
                                </div>`;
                            return;
                        }
                    }
                    this.state.user = auth.currentUser;
                    this.syncData();
                    this.render();
                });
            },

            syncData() {
                if (!this.state.user) return;
                const todayKey = `${this.state.currentYear}-${String(this.state.currentMonth).padStart(2, '0')}-${String(this.state.todayDay).padStart(2, '0')}`;
                
                // Suscribirse a puntos de hoy
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'daily_points', todayKey), (snap) => {
                    if (snap.exists()) {
                        this.state.taskPoints = snap.data().points || {};
                        this.render();
                    }
                });

                // Suscribirse a historial
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (snap) => {
                    const newHistory = {};
                    snap.forEach(doc => { newHistory[doc.id] = doc.data(); });
                    this.state.history = newHistory;
                    this.render();
                });
            },

            async updatePoints(taskId, delta, max) {
                if (this.state.viewingDate || !this.state.user) return;
                
                const current = this.state.taskPoints[taskId] || 0;
                let next = current + delta;
                if (max && next > max) next = max;
                if (next < -100) next = -100;

                const todayKey = `${this.state.currentYear}-${String(this.state.currentMonth).padStart(2, '0')}-${String(this.state.todayDay).padStart(2, '0')}`;
                
                // Actualizar estado local y Firebase
                this.state.taskPoints[taskId] = next;
                
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_points', todayKey), {
                        points: this.state.taskPoints,
                        total: Object.values(this.state.taskPoints).reduce((a, b) => a + (typeof b === 'number' ? b : 0), 0),
                        updatedAt: new Date().toISOString()
                    });
                } catch (e) { console.error("Error guardando puntos:", e); }
            },

            async saveDay() {
                const total = Object.values(this.state.taskPoints).reduce((a, b) => a + (typeof b === 'number' ? b : 0), 0);
                const todayKey = `${this.state.currentYear}-${String(this.state.currentMonth).padStart(2, '0')}-${String(this.state.todayDay).padStart(2, '0')}`;
                
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', todayKey), {
                        total,
                        details: this.state.taskPoints,
                        timestamp: new Date().toISOString()
                    });
                    this.state.taskPoints = {};
                    this.render();
                } catch (e) { console.error("Error cerrando show:", e); }
            },

            render() {
                const root = document.getElementById('app-root');
                const overlay = document.getElementById('bg-overlay');
                if (!root) return;

                const todayKey = `${this.state.currentYear}-${String(this.state.currentMonth).padStart(2, '0')}-${String(this.state.todayDay).padStart(2, '0')}`;
                const isHistory = this.state.viewingDate !== null && this.state.viewingDate !== todayKey;
                const activePoints = isHistory ? (this.state.history[this.state.viewingDate]?.details || {}) : this.state.taskPoints;
                const currentTotal = Object.values(activePoints).reduce((a, b) => a + (typeof b === 'number' ? b : 0), 0);
                const monthlyTotal = Object.values(this.state.history).reduce((a, b) => a + (b.total || 0), 0);
                const money = monthlyTotal * 100;

                overlay.className = `fixed inset-0 z-0 backdrop-blur-[4px] transition-colors duration-700 ${isHistory ? 'bg-indigo-950/85' : 'bg-black/75'}`;
                
                root.innerHTML = this.template(currentTotal, monthlyTotal, money, activePoints, isHistory);
                if (window.lucide) window.lucide.createIcons();
            },

            template(current, monthly, money, points, isHistory) {
                const marqueeText = isHistory ? `FLASHBACK: D√çA ${this.state.viewingDate.split('-')[2]}` : 'EVA ALEM√ÅN K-POP TOUR';
                
                return `
                    <div class="relative z-20 w-full border-y-4 border-white py-4 overflow-hidden shadow-2xl transition-colors ${isHistory ? 'bg-indigo-600' : 'bg-pink-600'}">
                        <div class="animate-marquee">
                            ${Array(10).fill(`<span class="text-4xl font-black italic uppercase tracking-tighter mx-8 flex items-center gap-4">
                                <i data-lucide="${isHistory ? 'history' : 'zap'}"></i> ${marqueeText} <i data-lucide="star" class="fill-white"></i>
                            </span>`).join('')}
                        </div>
                    </div>

                    <div class="p-4 md:p-8 lg:p-12 max-w-[1600px] mx-auto">
                        <div class="text-center mb-12 mt-4 relative">
                            ${isHistory ? `
                                <button onclick="window.KPopApp.state.viewingDate = null; window.KPopApp.render()" 
                                    class="absolute left-0 top-1/2 -translate-y-1/2 bg-white text-black px-8 py-4 rounded-full font-black flex items-center gap-4 hover:scale-110 transition-transform shadow-[0_0_20px_rgba(255,255,255,0.5)] z-50 border-4 border-indigo-400">
                                    <i data-lucide="arrow-left"></i> VOLVER
                                </button>` : ''}
                            <h1 class="text-7xl md:text-9xl font-black italic tracking-tighter leading-none uppercase text-white drop-shadow-[0_0_40px_rgba(236,72,153,0.8)] mb-2">
                                ${isHistory ? 'RECUERDO' : 'EVA ALEM√ÅN'}
                            </h1>
                            <p class="text-2xl font-black tracking-[0.5em] text-pink-400 uppercase italic">
                                ${isHistory ? `D√çA DE GIRA: ${this.state.viewingDate.split('-')[2]}` : 'EL MEJOR JUEGO'}
                            </p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
                            <section class="glass-card rounded-[4rem] p-10 border-4 ${isHistory ? 'bg-indigo-900/90 border-indigo-400' : 'border-pink-500 shadow-[0_0_60px_rgba(236,72,153,0.3)]'}">
                                <div class="flex items-center gap-6 mb-8 border-b-2 border-white/10 pb-6">
                                    <i data-lucide="crown" class="${isHistory ? 'text-indigo-400' : 'text-pink-500'}" size="44"></i>
                                    <h2 class="text-5xl font-black uppercase italic tracking-tighter">PUNTOS</h2>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="bg-white/5 p-8 rounded-[3rem] text-center border-2 border-white/10">
                                        <p class="text-[10px] font-black tracking-widest text-pink-400 uppercase mb-2">Puntos Hoy</p>
                                        <p class="text-7xl font-black">${current}</p>
                                    </div>
                                    <div class="${isHistory ? 'bg-indigo-600' : 'bg-pink-600'} p-8 rounded-[3rem] text-center shadow-xl">
                                        <p class="text-[10px] font-black tracking-widest text-white/70 uppercase mb-2">Mes</p>
                                        <p class="text-7xl font-black">${monthly}</p>
                                    </div>
                                </div>
                            </section>

                            <section class="bg-gradient-to-br from-indigo-900 via-purple-900 to-black rounded-[4rem] p-10 shadow-2xl border-4 border-indigo-500">
                                <div class="flex items-center gap-6 mb-8 border-b-2 border-indigo-500/30 pb-6">
                                    <i data-lucide="trophy" class="text-white" size="44"></i>
                                    <h2 class="text-5xl font-black uppercase italic tracking-tighter text-white">GANANCIAS</h2>
                                </div>
                                <div class="text-center mb-8">
                                    <p class="text-7xl md:text-8xl font-black text-white tracking-tighter">$${money.toLocaleString('es-CL')}</p>
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="bg-black/40 p-5 rounded-3xl text-center border border-white/10">
                                        <p class="text-[10px] font-black text-pink-300">GASTOS</p>
                                        <p class="text-lg font-black">$${(money * 0.5).toLocaleString('es-CL')}</p>
                                    </div>
                                    <div class="bg-black/40 p-5 rounded-3xl text-center border border-white/10">
                                        <p class="text-[10px] font-black text-blue-300">AHORRO</p>
                                        <p class="text-lg font-black">$${(money * 0.4).toLocaleString('es-CL')}</p>
                                    </div>
                                    <div class="bg-black/40 p-5 rounded-3xl text-center border border-white/10">
                                        <p class="text-[10px] font-black text-yellow-300">COMPARTE</p>
                                        <p class="text-lg font-black">$${(money * 0.1).toLocaleString('es-CL')}</p>
                                    </div>
                                </div>
                            </section>
                        </div>

                        <section class="mb-24">
                            <h2 class="text-6xl font-black uppercase italic tracking-tighter mb-12 px-4 ${isHistory ? 'text-indigo-400' : 'text-pink-500'}">
                                ${isHistory ? 'PASADO' : 'SETLIST DIARIO'}
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                ${this.tasks.map(t => {
                                    const p = points[t.id] || 0;
                                    const maxed = p >= t.max && t.max > 0;
                                    return `
                                        <div class="p-8 rounded-[4rem] border-[4px] transition-all ${maxed ? 'bg-pink-600 border-white shadow-lg' : 'bg-black/80 border-white/10'}">
                                            <div class="flex items-center justify-between mb-6">
                                                <span class="text-7xl drop-shadow-lg">${t.emoji}</span>
                                                <div class="flex flex-col items-center gap-3">
                                                    ${!isHistory ? `<button onclick="window.KPopApp.updatePoints('${t.id}', 1, ${t.max})" class="btn-action w-16 h-16 bg-yellow-400 text-black rounded-full text-4xl font-black shadow-lg">+</button>` : ''}
                                                    <span class="font-black text-6xl italic">${p}</span>
                                                    ${!isHistory ? `<button onclick="window.KPopApp.updatePoints('${t.id}', -1, ${t.max})" class="btn-action w-16 h-8 bg-white/10 rounded-full text-xl font-black">-</button>` : ''}
                                                </div>
                                            </div>
                                            <h3 class="font-black text-4xl italic uppercase leading-none">${t.label}</h3>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </section>

                        ${!isHistory ? `
                        <button onclick="window.KPopApp.saveDay()" class="btn-action w-full bg-pink-600 p-12 rounded-[4rem] font-black text-5xl md:text-7xl uppercase italic tracking-tighter text-white border-8 border-white shadow-[0_20px_50px_rgba(236,72,153,0.5)] flex items-center justify-center gap-8 mb-24">
                            <i data-lucide="music" size="48"></i> CERRAR SHOW <i data-lucide="mic-2" size="48"></i>
                        </button>` : ''}

                        <section class="bg-black/95 p-10 rounded-[4rem] border-4 border-pink-500/50 mb-16 shadow-3xl">
                            <h2 class="text-5xl font-black uppercase italic tracking-tighter mb-10 flex items-center gap-4">
                                <i data-lucide="calendar"></i> TOUR MAP
                            </h2>
                            <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-11 gap-4">
                                ${Array.from({length: 31}, (_, i) => {
                                    const day = i + 1;
                                    const dKey = `${this.state.currentYear}-${String(this.state.currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                    const hasHist = this.state.history[dKey];
                                    const isToday = day === this.state.todayDay;
                                    const isSelected = this.state.viewingDate === dKey;

                                    return `
                                        <button onclick="if(${hasHist || isToday}) { window.KPopApp.state.viewingDate = '${dKey}'; window.KPopApp.render(); }"
                                            class="aspect-square flex flex-col items-center justify-center rounded-2xl transition-all border-2
                                            ${isSelected ? 'bg-yellow-400 text-black border-white scale-110 z-10' : 
                                              isToday ? 'bg-white text-black border-pink-500' :
                                              hasHist ? 'bg-white/15 border-pink-500/40 text-white' : 'bg-white/5 border-transparent opacity-30'}">
                                            <span class="text-2xl font-black">${day}</span>
                                            ${hasHist ? `<div class="text-[8px] font-black">${hasHist.total}</div>` : ''}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </section>
                    </div>
                `;
            }
        };

        window.onload = () => window.KPopApp.init();
    </script>
</body>
</html>
