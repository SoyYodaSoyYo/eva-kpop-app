<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Juego de Eva K-POP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@400;700;900&family=Syne:wght@800&display=swap');

        * { box-sizing: border-box; }

        body {
            font-family: 'Archivo', sans-serif;
            background: #0a0006;
            color: #fff;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .font-arch { font-family: 'Archivo Black', sans-serif; }

        /* â”€â”€ MARQUEE â”€â”€ */
        .marquee-wrap {
            background: linear-gradient(90deg, #ff007f, #b30059);
            overflow: hidden; white-space: nowrap; padding: 9px 0;
            box-shadow: 0 0 18px rgba(255,0,127,.5);
            position: sticky; top: 0; z-index: 50;
        }
        .marquee-inner {
            display: inline-block;
            animation: marquee 22s linear infinite;
            font-family: 'Syne', sans-serif; font-weight: 800;
            text-transform: uppercase; font-size: 1.1rem; padding-left: 100%;
            letter-spacing: .05em;
        }
        @keyframes marquee { 0%{transform:translateX(0)} 100%{transform:translateX(-250%)} }

        /* â”€â”€ COLORES / EFECTOS â”€â”€ */
        .neon { color: #ff007f; text-shadow: 0 0 10px #ff007f, 0 0 30px #ff007f; }
        .glass {
            background: rgba(255,255,255,.05);
            border: 1px solid rgba(255,255,255,.1);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }

        /* â”€â”€ TABS â”€â”€ */
        .tab-btn {
            flex:1; padding:13px 4px; border-radius:11px;
            font-family:'Archivo Black',sans-serif; font-style:italic;
            text-transform:uppercase; font-size:11px; cursor:pointer;
            transition:all .2s; opacity:.5; background:none; border:none; color:#fff;
        }
        .tab-btn.active { background:#fff; color:#000; opacity:1; box-shadow:0 0 14px rgba(255,255,255,.2); }

        /* â”€â”€ TARJETA DE TAREA â”€â”€ */
        .task-card {
            background: rgba(255,255,255,.04);
            border: 1px solid rgba(255,255,255,.08);
            border-left: 4px solid rgba(255,255,255,.12);
            border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; gap: 13px;
            margin-bottom: 11px;
            transition: all .3s;
        }
        .task-card.done {
            border-left-color: #ff007f;
            background: linear-gradient(90deg, rgba(255,0,127,.11) 0%, transparent 100%);
            animation: pulse-glow 2s infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: inset 0 0 8px rgba(255,0,127,.04); }
            to   { box-shadow: inset 0 0 22px rgba(255,0,127,.16); }
        }

        /* â”€â”€ SEGMENTOS DE PROGRESO â”€â”€ */
        .seg {
            height: 7px; flex: 1; border-radius: 4px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.09);
            transition: all .3s;
        }
        .seg.on { background:#ff007f; border-color:#ff007f; box-shadow:0 0 7px #ff007f; }

        /* â”€â”€ BOTONES +/- â”€â”€ */
        .btn-m {
            width:40px; height:40px; border-radius:10px;
            background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
            color:rgba(255,255,255,.45); font-size:20px; font-weight:900;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            transition:all .12s; user-select:none; -webkit-user-select:none;
        }
        .btn-p {
            width:40px; height:40px; border-radius:10px;
            background:#ff007f; border:none; border-bottom:4px solid #a8005a;
            color:#fff; font-size:22px; font-weight:900;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            box-shadow:0 0 12px rgba(255,0,127,.35);
            transition:all .12s; user-select:none; -webkit-user-select:none;
        }
        .btn-p.off { background:#3a3a3a; border-bottom-color:#222; box-shadow:none; opacity:.45; }
        .btn-m:active, .btn-p:active { transform:scale(.85); }

        /* â”€â”€ BARRA DE PROGRESO PREMIOS â”€â”€ */
        .prog-track {
            width:100%; height:9px;
            background:rgba(0,0,0,.5); border-radius:999px;
            overflow:hidden; border:1px solid rgba(255,255,255,.07);
        }
        .prog-fill { height:100%; border-radius:999px; transition:width .9s; }

        /* â”€â”€ TOAST â”€â”€ */
        #toasts {
            position:fixed; top:68px; right:12px; z-index:300;
            display:flex; flex-direction:column; gap:9px;
            pointer-events:none;
            width: min(290px, calc(100vw - 24px));
        }
        .toast {
            background:rgba(8,0,8,.88);
            border:1px solid rgba(255,255,255,.1); border-left:4px solid #ff007f;
            border-radius:13px; padding:13px 15px;
            backdrop-filter:blur(18px);
            animation: tIn .38s cubic-bezier(.17,.89,.32,1.28);
        }
        .toast.out     { animation: tOut .3s ease-in forwards; }
        .toast.perfect { border-left-color:#facc15; }
        .toast.reward  { border-left-color:#22d3ee; }
        .toast.bad     { border-left-color:#f87171; }
        @keyframes tIn  { from{transform:translateX(108%);opacity:0} to{transform:translateX(0);opacity:1} }
        @keyframes tOut { from{transform:translateX(0);opacity:1} to{transform:translateX(108%);opacity:0} }

        /* â”€â”€ CONFETI â”€â”€ */
        #fx-canvas { position:fixed; inset:0; pointer-events:none; z-index:900; }

        /* â”€â”€ FOOTER â”€â”€ */
        #footer {
            position:fixed; bottom:0; left:0; width:100%;
            background:linear-gradient(to top, #000 55%, transparent);
            padding:14px 16px 22px; z-index:40;
        }
        .btn-bonus {
            flex:1; padding:15px; border:none; border-radius:14px;
            font-family:'Archivo Black',sans-serif; font-style:italic;
            text-transform:uppercase; font-size:12px; cursor:pointer;
            transition: transform .12s;
        }
        .btn-bonus:active { transform:scale(.93); }

        /* â”€â”€ HISTORIAL â”€â”€ */
        .hist-row {
            display:flex; justify-content:space-between; align-items:center;
            padding:13px 16px; border-radius:13px; margin-bottom:9px;
            background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06);
        }
    </style>
</head>
<body class="pb-36">

<!-- CONFETI -->
<canvas id="fx-canvas"></canvas>

<!-- NOTIFICACIONES -->
<div id="toasts"></div>

<!-- MARQUEE -->
<div class="marquee-wrap">
    <span class="marquee-inner">
        â€¢ GANA PUNTOS â€¢ AHORRA PARA EL FUTURO â€¢ DISFRUTA TU GIRA â€¢ DÃA PERFECTO â€¢ K-POP STAR â€¢&nbsp;&nbsp;
        GANA PUNTOS â€¢ AHORRA PARA EL FUTURO â€¢ DISFRUTA TU GIRA â€¢ DÃA PERFECTO â€¢ K-POP STAR â€¢
    </span>
</div>

<!-- HEADER -->
<header style="text-align:center;padding:32px 24px 28px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.35)">
    <h1 class="font-arch neon" style="font-size:4.2rem;font-style:italic;letter-spacing:-.05em;line-height:1;margin:0 0 20px">EVA<br>K-POP</h1>
    <div class="glass" style="display:inline-block;padding:18px 36px;border-radius:24px;border-top:1px solid rgba(255,255,255,.15)">
        <div id="total-pts" class="font-arch" style="font-size:4.5rem;font-style:italic;color:#fff">0</div>
        <p style="font-size:10px;font-weight:900;color:#ff4da6;text-transform:uppercase;letter-spacing:.4em;margin:6px 0 0">Puntos Totales</p>
    </div>
</header>

<!-- CONTENIDO PRINCIPAL -->
<main style="max-width:440px;margin:0 auto;padding:20px 16px 8px">

    <!-- TABS -->
    <div class="glass" style="display:flex;gap:6px;padding:6px;border-radius:16px;margin-bottom:20px">
        <button class="tab-btn active" id="tab-tasks"   onclick="App.tab('tasks')">Misiones</button>
        <button class="tab-btn"        id="tab-rewards" onclick="App.tab('rewards')">Premios</button>
        <button class="tab-btn"        id="tab-history" onclick="App.tab('history')">Historial</button>
    </div>

    <div id="content"></div>
</main>

<!-- FOOTER CON BOTONES DE AJUSTE RÃPIDO -->
<div id="footer">
    <div style="max-width:440px;margin:0 auto;display:flex;gap:12px">
        <button class="btn-bonus" onclick="App.bonus(10)"
            style="background:#facc15;color:#000;border-bottom:4px solid #b8960a;box-shadow:0 0 16px rgba(250,204,21,.25)">
            Bono Extra +10
        </button>
        <button class="btn-bonus" onclick="App.bonus(-5)"
            style="background:#27272a;color:#fff;border:1px solid rgba(255,255,255,.1);border-bottom:4px solid #000">
            Falta Grave &minus;5
        </button>
    </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVA K-POP  â€”  v4.0
   Funciona 100% offline con localStorage.
   Para sincronizar entre dispositivos, configura Firebase mÃ¡s abajo.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONFIGURACIÃ“N FIREBASE (OPCIONAL)
   Si no tienes Firebase, deja estos valores tal cual.
   La app funciona perfectamente sin ellos.

   Para activar la sincronizaciÃ³n multi-dispositivo:
   1. Ve a https://console.firebase.google.com
   2. Crea un proyecto â†’ Agrega una app web
   3. Copia los valores que te entrega y pÃ©galos aquÃ­
   4. En Firestore â†’ Reglas: allow read, write: if true;
   5. En Authentication â†’ Habilita "AnÃ³nimo"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var FIREBASE_ON = false; // â† Cambia a true cuando tengas los datos
var FIREBASE_CONFIG = {
    apiKey:            "",
    authDomain:        "",
    projectId:         "",
    storageBucket:     "",
    messagingSenderId: "",
    appId:             ""
};
var GAME_ID = "eva-kpop-v4"; // No cambiar una vez que hayas guardado datos
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var SFX = (function(){
    var ctx = null;
    function getCtx() {
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        return ctx;
    }
    function play(freq, type, dur, vol, delay) {
        delay = delay || 0;
        try {
            var c = getCtx();
            var osc = c.createOscillator(), g = c.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, c.currentTime + delay);
            g.gain.setValueAtTime(vol, c.currentTime + delay);
            g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + delay + dur);
            osc.connect(g); g.connect(c.destination);
            osc.start(c.currentTime + delay);
            osc.stop(c.currentTime + delay + dur);
        } catch(e){}
    }
    return {
        unlock:  function(){ try{ getCtx(); }catch(e){} },
        coin:    function(){ play(900,'sine',.1,.2); play(1200,'sine',.15,.2,.05); },
        error:   function(){ play(300,'sawtooth',.2,.1); play(200,'sawtooth',.3,.1,.15); },
        win:     function(){ [400,500,600,800].forEach(function(f,i){ play(f,'square',i===3?.3:.1,.1,i*.1); }); },
        perfect: function(){ [523,659,784,1047].forEach(function(f,i){ play(f,'sine',.4,.2,i*.1); }); }
    };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var FX = (function(){
    var cv, ctx2d, parts = [];
    var cols = ['#ff007f','#facc15','#00f2fe','#fff','#ff66b2'];
    function loop(){
        ctx2d.clearRect(0,0,cv.width,cv.height);
        for(var i=parts.length-1;i>=0;i--){
            var p=parts[i];
            p.x+=p.vx; p.y+=p.vy; p.vy+=.4;
            p.spin+=p.sp; p.life-=.013;
            if(p.life<=0){ parts.splice(i,1); continue; }
            ctx2d.save();
            ctx2d.globalAlpha=Math.max(0,p.life);
            ctx2d.fillStyle=p.col;
            ctx2d.translate(p.x,p.y);
            ctx2d.rotate(p.spin*Math.PI/180);
            ctx2d.fillRect(-p.sz/2,-p.sz/2,p.sz,p.sz);
            ctx2d.restore();
        }
        requestAnimationFrame(loop);
    }
    return {
        init: function(){
            cv=document.getElementById('fx-canvas');
            ctx2d=cv.getContext('2d');
            function resize(){ cv.width=innerWidth; cv.height=innerHeight; }
            resize(); window.addEventListener('resize',resize);
            loop();
        },
        burst: function(){
            for(var i=0;i<160;i++) parts.push({
                x:innerWidth/2, y:innerHeight/2,
                vx:(Math.random()-.5)*26, vy:(Math.random()-1)*26-4,
                sz:Math.random()*8+4,
                col:cols[Math.floor(Math.random()*cols.length)],
                life:1, spin:Math.random()*360, sp:(Math.random()-.5)*10
            });
        }
    };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(title, msg, type){
    type = type || 'normal';
    var box = document.getElementById('toasts');
    var el = document.createElement('div');
    el.className = 'toast' + (type==='perfect'?' perfect':type==='reward'?' reward':type==='bad'?' bad':'');
    el.innerHTML =
        '<div style="font-family:\'Archivo Black\',sans-serif;font-style:italic;font-size:16px;margin-bottom:3px">' + title + '</div>' +
        '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;opacity:.8">' + msg + '</div>';
    box.appendChild(el);
    setTimeout(function(){
        el.classList.add('out');
        setTimeout(function(){ el.remove(); }, 320);
    }, 3600);
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATOS POR DEFECTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function emptyData(){
    return {
        total: 0,
        today: { date:'', points:{}, totalDay:0, basePoints:0, perfectDay:false },
        week:  { id:'', pts:0, claimed:[] },
        month: { id:'', pts:0, claimed:[] },
        history: [],
        activeTab: 'tasks',
        lastSync: 0
    };
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var App = {

    d: emptyData(),
    _fb: null,
    _unsub: null,
    _saveTimer: null,
    _skipSnap: false,
    POINT_VALUE: 10,

    TASKS: [
        { id:'cama',     label:'Hacer la cama',       pts:1, limit:1, icon:'ğŸ›ï¸' },
        { id:'espacio',  label:'Mi espacio ordenado',  pts:1, limit:1, icon:'ğŸ§¹' },
        { id:'dientes',  label:'Lavarse los dientes',  pts:1, limit:6, icon:'ğŸ¦·' },
        { id:'dormir',   label:'Dormir sola',          pts:1, limit:1, icon:'ğŸŒ™' },
        { id:'banarse',  label:'BaÃ±arse Sola',         pts:1, limit:1, icon:'ğŸ›' },
        { id:'vestirse', label:'Vestirse Sola',        pts:1, limit:1, icon:'ğŸ‘—' },
        { id:'tarea',    label:'Tareas escolares',     pts:1, limit:1, icon:'ğŸ“š' },
        { id:'leer',     label:'Leer',                 pts:1, limit:6, icon:'ğŸ“–' },
        { id:'crear',    label:'Crear algo',           pts:1, limit:2, icon:'ğŸ¨' },
        { id:'comida',   label:'Comida balanceada',    pts:1, limit:3, icon:'ğŸ¥—' },
        { id:'honesto',  label:'DÃ­a honesto',          pts:5, limit:1, icon:'ğŸ˜‡' },
        { id:'gritos',   label:'DÃ­a sin gritos',       pts:5, limit:1, icon:'ğŸ¤«' }
    ],

    WEEKLY:  [ {label:'PelÃ­cula Extra', pts:100}, {label:'Helado Especial', pts:180} ],
    MONTHLY: [ {label:'Regalo Sorpresa',pts:400}, {label:'Paseo + Regalo',  pts:800} ],

    FINANCE: [
        {label:'Libres para usar', pct:.40, color:'#ff7eb3', desc:'Libre disposiciÃ³n'},
        {label:'Gastos',           pct:.40, color:'#ffaacc', desc:'Necesidades / Extras'},
        {label:'Ahorro',           pct:.10, color:'#ffffff', desc:'Para el futuro'},
        {label:'Compartir',        pct:.10, color:'#aaaaaa', desc:'Ayudar / Regalar'}
    ],

    /* â”€â”€ Fechas â”€â”€ */
    _hoy:  function(){ return new Date().toISOString().split('T')[0]; },
    _mes:  function(){ return this._hoy().slice(0,7); },
    _semana: function(){
        var d = new Date();
        d.setDate(d.getDate() - (d.getDay()+1)%7);
        return d.toISOString().split('T')[0];
    },

    /* â”€â”€ Reseteos diario / semanal / mensual â”€â”€ */
    _checkResets: function(){
        var h=this._hoy(), s=this._semana(), m=this._mes();
        var changed=false;
        if(this.d.today.date !== h){
            if(this.d.today.date) this.d.history.push(JSON.parse(JSON.stringify(this.d.today)));
            this.d.today = {date:h,points:{},totalDay:0,basePoints:0,perfectDay:false};
            changed=true;
        }
        if(!this.d.week  || this.d.week.id  !== s){ this.d.week  = {id:s,pts:0,claimed:[]}; changed=true; }
        if(!this.d.month || this.d.month.id !== m){ this.d.month = {id:m,pts:0,claimed:[]}; changed=true; }
        return changed;
    },

    /* â”€â”€ Local storage â”€â”€ */
    _loadLocal: function(){
        try{
            var raw = localStorage.getItem('eva_kpop_v4');
            if(raw){
                var parsed = JSON.parse(raw);
                this.d = Object.assign(emptyData(), parsed);
            }
        }catch(e){}
    },
    _saveLocal: function(){
        try{ localStorage.setItem('eva_kpop_v4', JSON.stringify(this.d)); }catch(e){}
    },

    /* â”€â”€ Guardar (local + nube si estÃ¡ activa) â”€â”€ */
    _save: function(){
        this._saveLocal();
        this._cloudSave();
        this._render();
    },

    /* â”€â”€ Firebase: guardar con debounce â”€â”€ */
    _cloudSave: function(){
        if(!this._fb) return;
        var self = this;
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(function(){
            try{
                self._skipSnap = true;
                var ref = self._fb.doc(self._fb.db, 'games', GAME_ID);
                self._fb.setDoc(ref, Object.assign({}, self.d, {lastSync: Date.now()}));
            }catch(e){}
        }, 700);
    },

    /* â”€â”€ Milestones â”€â”€ */
    _checkMilestones: function(){
        var maxBase = this.TASKS.reduce(function(s,t){ return s + t.pts*t.limit; }, 0);
        if(this.d.today.basePoints >= maxBase && !this.d.today.perfectDay){
            this.d.today.perfectDay = true;
            this.d.total           += 20;
            this.d.today.totalDay  += 20;
            this.d.week.pts        += 20;
            this.d.month.pts       += 20;
            FX.burst(); SFX.perfect();
            showToast('Â¡DÃA PERFECTO! ğŸŒŸ','Â¡Completaste todo! +20 Puntos Extra','perfect');
        }
        var self = this;
        this.WEEKLY.forEach(function(g,i){
            if(self.d.week.pts >= g.pts && self.d.week.claimed.indexOf(i)===-1){
                self.d.week.claimed.push(i);
                FX.burst(); SFX.win();
                showToast('Â¡PREMIO SEMANAL! ğŸ','Desbloqueaste: '+g.label,'reward');
            }
        });
        this.MONTHLY.forEach(function(g,i){
            if(self.d.month.pts >= g.pts && self.d.month.claimed.indexOf(i)===-1){
                self.d.month.claimed.push(i);
                FX.burst(); SFX.win();
                showToast('Â¡PREMIO MENSUAL! ğŸ','Desbloqueaste: '+g.label,'reward');
            }
        });
    },

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ACCIONES PÃšBLICAS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    adjust: function(id, dir){
        SFX.unlock();
        var task = null;
        for(var i=0;i<this.TASKS.length;i++){ if(this.TASKS[i].id===id){ task=this.TASKS[i]; break; } }
        var cur = this.d.today.points[id] || 0;
        if(dir>0 && cur>=task.limit) return;
        if(dir<0 && cur<=0) return;
        var delta = dir * task.pts;
        this.d.today.points[id]  = cur + dir;
        this.d.today.totalDay   += delta;
        this.d.today.basePoints += delta;
        this.d.total            += delta;
        this.d.week.pts   = Math.max(0, this.d.week.pts  + delta);
        this.d.month.pts  = Math.max(0, this.d.month.pts + delta);
        if(dir>0) SFX.coin(); else SFX.error();
        this._checkMilestones();
        this._save();
    },

    bonus: function(pts){
        SFX.unlock();
        if(pts>0){ SFX.coin(); showToast('Â¡BONO EXTRA!','+'+pts+' Puntos aÃ±adidos'); }
        else      { SFX.error(); showToast('PENALIZACIÃ“N',pts+' Puntos restados','bad'); }
        this.d.total          += pts;
        this.d.today.totalDay += pts;
        this.d.week.pts   = Math.max(0, this.d.week.pts  + pts);
        this.d.month.pts  = Math.max(0, this.d.month.pts + pts);
        this._checkMilestones();
        this._save();
    },

    tab: function(t){ this.d.activeTab=t; this._render(); },

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RENDER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    _clp: function(v){
        return new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:0}).format(v);
    },

    _render: function(){
        var ptEl = document.getElementById('total-pts');
        if(ptEl) ptEl.textContent = this.d.total;

        ['tasks','rewards','history'].forEach(function(t){
            var b = document.getElementById('tab-'+t);
            if(b) b.className = 'tab-btn' + (App.d.activeTab===t?' active':'');
        });

        var c = document.getElementById('content');
        if(!c) return;
        if(this.d.activeTab==='tasks')   c.innerHTML = this._buildTasks();
        if(this.d.activeTab==='rewards') c.innerHTML = this._buildRewards();
        if(this.d.activeTab==='history') c.innerHTML = this._buildHistory();
    },

    _buildTasks: function(){
        var html = '';
        if(this.d.today.perfectDay){
            html += '<div style="background:rgba(250,204,21,.14);border:2px solid #facc15;border-radius:14px;padding:14px 16px;text-align:center;margin-bottom:14px">' +
                '<div style="font-family:\'Archivo Black\',sans-serif;font-style:italic;color:#facc15;font-size:1rem">Â¡DÃA PERFECTO LOGRADO! ğŸŒŸ</div>' +
                '<div style="font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:.12em;margin-top:5px;opacity:.75">+20 Puntos de bonificaciÃ³n asignados</div>' +
                '</div>';
        }
        var self = this;
        this.TASKS.forEach(function(t){
            var count = self.d.today.points[t.id] || 0;
            var maxed = count >= t.limit;
            var segs = '';
            for(var i=0;i<t.limit;i++) segs += '<div class="seg'+(i<count?' on':'')+'"></div>';
            html +=
                '<div class="task-card'+(maxed?' done':'')+'">' +
                  '<div style="display:flex;justify-content:space-between;align-items:center">' +
                    '<div style="display:flex;align-items:center;gap:11px">' +
                      '<div style="width:46px;height:46px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.07);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.4rem">' + t.icon + '</div>' +
                      '<div>' +
                        '<div style="font-weight:700;font-style:italic;text-transform:uppercase;font-size:.81rem;color:rgba(255,255,255,.88)">' + t.label + '</div>' +
                        '<div style="font-weight:900;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#facc15;margin-top:2px">+' + t.pts + ' PTS</div>' +
                      '</div>' +
                    '</div>' +
                    (maxed
                      ? '<div style="background:#ff007f;font-size:9px;font-weight:900;padding:4px 9px;border-radius:6px;font-style:italic;font-family:\'Archivo Black\',sans-serif">COMPLETO</div>'
                      : '<div style="font-weight:900;font-size:13px;color:rgba(255,255,255,.45);background:rgba(0,0,0,.4);padding:4px 11px;border-radius:8px">' + count + '/' + t.limit + '</div>'
                    ) +
                  '</div>' +
                  '<div style="display:flex;align-items:center;gap:13px">' +
                    '<div style="flex:1;display:flex;gap:5px">' + segs + '</div>' +
                    '<div style="display:flex;gap:6px">' +
                      '<button class="btn-m" onclick="App.adjust(\'' + t.id + '\',-1)">âˆ’</button>' +
                      '<button class="btn-p' + (maxed?' off':'') + '" onclick="App.adjust(\'' + t.id + '\',1)">+</button>' +
                    '</div>' +
                  '</div>' +
                '</div>';
        });
        return html;
    },

    _buildRewards: function(){
        var html = '';
        var self = this;

        /* Semanales */
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin:14px 2px 10px">' +
            '<div style="font-family:\'Archivo Black\',sans-serif;font-style:italic;color:#facc15;font-size:12px;text-transform:uppercase;letter-spacing:.18em">Premios Semanales</div>' +
            '<div style="font-size:9px;font-weight:900;text-transform:uppercase;background:rgba(255,255,255,.07);padding:3px 9px;border-radius:7px">' + this.d.week.pts + ' pts</div>' +
            '</div>';
        this.WEEKLY.forEach(function(g,i){
            var done = self.d.week.claimed.indexOf(i) !== -1;
            var pct  = Math.min(100, self.d.week.pts/g.pts*100);
            html += self._rewardCard(g.label, g.pts, pct, done, '#facc15');
        });

        /* Mensuales */
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin:22px 2px 10px">' +
            '<div style="font-family:\'Archivo Black\',sans-serif;font-style:italic;color:#22d3ee;font-size:12px;text-transform:uppercase;letter-spacing:.18em">Premios Mensuales</div>' +
            '<div style="font-size:9px;font-weight:900;text-transform:uppercase;background:rgba(255,255,255,.07);padding:3px 9px;border-radius:7px">' + this.d.month.pts + ' pts</div>' +
            '</div>';
        this.MONTHLY.forEach(function(g,i){
            var done = self.d.month.claimed.indexOf(i) !== -1;
            var pct  = Math.min(100, self.d.month.pts/g.pts*100);
            html += self._rewardCard(g.label, g.pts, pct, done, '#22d3ee');
        });

        /* Finanzas */
        var total = this.d.total * this.POINT_VALUE;
        html +=
            '<div style="font-family:\'Archivo Black\',sans-serif;font-style:italic;color:#ff7eb3;font-size:12px;text-transform:uppercase;letter-spacing:.18em;margin:26px 2px 10px">Ganancias (CLP)</div>' +
            '<div style="background:rgba(255,0,127,.1);border:1px solid rgba(255,0,127,.22);border-radius:18px;padding:22px;text-align:center;margin-bottom:12px">' +
              '<div style="font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:.15em;opacity:.45;margin-bottom:7px">Saldo Real Total</div>' +
              '<div class="font-arch neon" style="font-size:2.6rem;font-style:italic">' + this._clp(total) + '</div>' +
            '</div>';
        this.FINANCE.forEach(function(f){
            html +=
                '<div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-left:3px solid '+f.color+';border-radius:13px;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:9px">' +
                  '<div>' +
                    '<div style="font-weight:900;font-style:italic;text-transform:uppercase;font-size:12px;color:'+f.color+'">' + f.label + ' (' + (f.pct*100|0) + '%)</div>' +
                    '<div style="font-size:10px;opacity:.35;text-transform:uppercase;margin-top:2px">' + f.desc + '</div>' +
                  '</div>' +
                  '<div style="font-family:\'Archivo Black\',sans-serif;font-style:italic;font-size:1.15rem">' + self._clp(total*f.pct) + '</div>' +
                '</div>';
        });
        return html;
    },

    _rewardCard: function(label, pts, pct, done, color){
        return '<div style="background:' + (done?'rgba(34,197,94,.07)':'rgba(255,255,255,.04)') + ';border:1px solid rgba(255,255,255,.07);border-left:4px solid ' + (done?'#22c55e':color) + ';border-radius:14px;padding:14px 16px;margin-bottom:10px;position:relative;overflow:hidden">' +
            (done?'<div style="position:absolute;top:-9px;right:-15px;background:#22c55e;color:#000;font-size:8px;font-weight:900;padding:15px 17px 4px;transform:rotate(45deg)">LISTO</div>':'') +
            '<div style="display:flex;justify-content:space-between;margin-bottom:11px">' +
              '<span style="font-weight:700;font-style:italic;text-transform:uppercase;font-size:12px">' + label + '</span>' +
              '<span style="font-weight:900;font-size:13px;color:' + color + '">' + pts + ' PTS</span>' +
            '</div>' +
            '<div class="prog-track"><div class="prog-fill" style="width:'+pct+'%;background:'+(done?'#22c55e':color)+';'+(done?'':'box-shadow:0 0 7px '+color)+'"></div></div>' +
            '</div>';
    },

    _buildHistory: function(){
        var hist = this.d.history.slice().reverse();
        var html =
            '<div style="font-family:\'Archivo Black\',sans-serif;font-style:italic;color:#ff7eb3;font-size:12px;text-transform:uppercase;letter-spacing:.18em;margin-bottom:13px">Logros Recientes</div>' +
            '<div style="background:linear-gradient(90deg,rgba(255,0,127,.16) 0%,transparent 100%);border:1px solid rgba(255,0,127,.27);border-radius:15px;padding:16px 18px;margin-bottom:13px;position:relative;overflow:hidden">' +
              (this.d.today.perfectDay?'<div style="position:absolute;top:0;right:0;background:#facc15;color:#000;font-size:9px;font-weight:900;padding:4px 10px;border-radius:0 15px 0 11px">DÃA PERFECTO ğŸŒŸ</div>':'') +
              '<div style="display:flex;justify-content:space-between;align-items:flex-end">' +
                '<div>' +
                  '<div style="background:#ff007f;display:inline-block;font-size:10px;font-weight:900;padding:3px 8px;border-radius:5px;margin-bottom:5px">HOY</div>' +
                  '<div style="font-weight:700;font-style:italic;text-transform:uppercase;font-size:.83rem">' + this.d.today.date + '</div>' +
                '</div>' +
                '<div style="font-family:\'Archivo Black\',sans-serif;font-size:2rem;font-style:italic">' + this.d.today.totalDay + ' <span style="font-size:11px;color:#ff99cc">PTS</span></div>' +
              '</div>' +
            '</div>';

        if(hist.length===0){
            html += '<div style="text-align:center;padding:36px;opacity:.28;font-style:italic;text-transform:uppercase;font-size:.82rem">AÃºn no hay dÃ­as anteriores</div>';
        } else {
            hist.forEach(function(day){
                html += '<div class="hist-row">' +
                    '<span style="font-weight:700;font-style:italic;text-transform:uppercase;font-size:11px">' + day.date + '</span>' +
                    '<div style="display:flex;align-items:center;gap:9px">' +
                      (day.perfectDay?'<span style="font-size:.95rem">ğŸŒŸ</span>':'') +
                      '<span style="font-family:\'Archivo Black\',sans-serif;font-style:italic;font-size:1.05rem">' + day.totalDay + ' <span style="font-size:10px;opacity:.45">PTS</span></span>' +
                    '</div>' +
                '</div>';
            });
        }
        return html;
    },

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INIT  â€”  arranca la app INMEDIATAMENTE con datos
       locales, luego conecta Firebase en segundo plano
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    init: function(){
        var self = this;
        FX.init();

        /* 1. Cargar local y mostrar ya */
        this._loadLocal();
        this._checkResets();
        this._render();

        /* 2. Firebase en segundo plano (solo si estÃ¡ activado) */
        if(!FIREBASE_ON || !FIREBASE_CONFIG.apiKey){ return; }

        /* Carga dinÃ¡mica de Firebase para no bloquear nada */
        Promise.all([
            import("https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js"),
            import("https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js"),
            import("https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js")
        ]).then(function(modules){
            var initApp = modules[0].initializeApp;
            var fs      = modules[1];
            var initAuth= modules[2].getAuth;
            var signIn  = modules[2].signInAnonymously;

            var app  = initApp(FIREBASE_CONFIG);
            var db   = fs.getFirestore(app);
            var auth = initAuth(app);

            self._fb = {
                db:     db,
                doc:    fs.doc,
                getDoc: fs.getDoc,
                setDoc: fs.setDoc,
                onSnapshot: fs.onSnapshot
            };

            signIn(auth).then(function(){
                var ref = fs.doc(db, 'games', GAME_ID);

                /* Carga inicial: tomar el mÃ¡s reciente */
                fs.getDoc(ref).then(function(snap){
                    if(snap.exists()){
                        var cloud = snap.data();
                        if((cloud.lastSync||0) >= (self.d.lastSync||0)){
                            self.d = Object.assign(emptyData(), cloud);
                        }
                    }
                    self._checkResets();
                    self._saveLocal();
                    self._render();

                    /* Listener en tiempo real */
                    self._unsub = fs.onSnapshot(ref, function(snap){
                        if(self._skipSnap){ self._skipSnap=false; return; }
                        if(!snap.exists()) return;
                        var cloud = snap.data();
                        if((cloud.lastSync||0) > (self.d.lastSync||0)){
                            self.d = Object.assign(emptyData(), cloud);
                            self._checkResets();
                            self._saveLocal();
                            self._render();
                            showToast('Sincronizado â˜ï¸','Datos actualizados desde otro dispositivo');
                        }
                    });
                });
            });
        }).catch(function(e){
            console.warn('Firebase no disponible:', e.message);
        });
    }
};

/* Arrancar */
window.App = App;
document.addEventListener('DOMContentLoaded', function(){ App.init(); });
</script>

</body>
</html>
