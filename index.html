<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eva K-Pop Tour - Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@400;600;800&display=swap');
        
        :root {
            /* REEMPLAZA ESTE LINK CON TU IMAGEN DIRECTA */
            --bg-url: url('https://images.tcdn.com.br/img/img_prod/1129828/k_pop_hunters_volume_1_e_2_3127_1_15d868953923485f762744d567118833.jpg');
        }

        body { 
            font-family: 'Archivo', sans-serif; 
            background-color: #0b0b0b;
            color: white;
            margin: 0;
            padding: 0;
            user-select: none;
            /* Configuracion de fondo robusta */
            background-image: var(--bg-url);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        /* Capa oscura ajustable: si quieres ver mas la imagen, baja el 0.8 a 0.5 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75); 
            z-index: 0;
            pointer-events: none;
        }

        #app { position: relative; z-index: 1; }

        .font-header { font-family: 'Archivo Black', sans-serif; }

        .glass {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .kpop-gradient {
            background: linear-gradient(135deg, #ff0080 0%, #7928ca 100%);
        }

        .tab-active {
            border-bottom: 3px solid #ff0080;
            color: #ff0080;
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .animate-marquee {
            display: inline-flex;
            animation: marquee 15s linear infinite;
        }

        .btn-press:active { transform: scale(0.9); }
        
        .btn-minus {
            background: rgba(239, 68, 68, 0.25);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ff4d4d;
        }
    </style>
</head>
<body class="pb-24">
    <div class="overlay"></div>

    <div id="app">
        <!-- Header -->
        <header class="p-6 kpop-gradient sticky top-0 z-50 shadow-2xl">
            <div class="flex justify-between items-center max-w-4xl mx-auto">
                <div>
                    <h1 class="font-header text-2xl italic tracking-tighter uppercase">Eva World Tour</h1>
                    <p class="text-[10px] font-bold opacity-80 tracking-widest uppercase">Sistema de Puntuaci√≥n</p>
                </div>
                <div class="text-right">
                    <span id="display-date" class="text-xs font-black opacity-70 uppercase tracking-tighter">Cargando...</span>
                </div>
            </div>
        </header>

        <!-- Marquesina -->
        <div class="bg-white text-black py-2 overflow-hidden whitespace-nowrap border-b border-white/20">
            <div class="animate-marquee flex items-center">
                <span class="mx-4 font-black italic text-xs uppercase tracking-widest">EVA X K-POP CHALLENGE 2024</span>
                <span class="mx-4 text-pink-600">‚ú¶</span>
                <span class="mx-4 font-black italic text-xs uppercase tracking-widest">EVA X K-POP CHALLENGE 2024</span>
                <span class="mx-4 text-pink-600">‚ú¶</span>
                <span class="mx-4 font-black italic text-xs uppercase tracking-widest">EVA X K-POP CHALLENGE 2024</span>
                <span class="mx-4 text-pink-600">‚ú¶</span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex justify-around bg-black/40 border-b border-white/10 sticky top-[76px] z-40 backdrop-blur-md">
            <button onclick="window.App.setTab('daily')" id="tab-daily" class="py-4 px-6 text-xs font-black uppercase tracking-widest tab-active">Misiones</button>
            <button onclick="window.App.setTab('rewards')" id="tab-rewards" class="py-4 px-6 text-xs font-black uppercase tracking-widest opacity-50">Premios</button>
            <button onclick="window.App.setTab('history')" id="tab-history" class="py-4 px-6 text-xs font-black uppercase tracking-widest opacity-50">Gira</button>
        </nav>

        <main class="p-4 max-w-4xl mx-auto">
            <div id="loading-overlay" class="py-20 text-center">
                <div class="inline-block w-8 h-8 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <div id="content" class="hidden"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'eva-kpop-tour';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const App = {
            currentTab: 'daily',
            user: null,
            data: { today: {}, allHistory: [] },
            
            tasks: [
                { id: 'h1', label: 'Hacer la cama', icon: 'üõèÔ∏è', max: 1 },
                { id: 'h2', label: 'Dientes', icon: 'ü™•', max: 6 },
                { id: 'h3', label: 'Dormir sola', icon: 'üåô', max: 1 },
                { id: 'h4', label: 'Ba√±arse sola', icon: 'üöø', max: 1 },
                { id: 'h5', label: 'Vestirse sola', icon: 'üëó', max: 1 },
                { id: 'h6', label: 'Leer', icon: 'üìö', max: 6 },
                { id: 'h7', label: 'Tarea', icon: 'üìù', max: 4 },
                { id: 's1', label: 'Balance con comida', icon: 'üçé', max: 5 },
                { id: 'v1', label: 'No enga√±ar', icon: 'üòá', max: 10 },
                { id: 'v2', label: 'No gritar / imponerse', icon: 'ü§´', max: 3 },
                { id: 'v3', label: 'Respetar mayores', icon: 'ü§ù', max: 6 }
            ],

            rewards: [
                { id: 'r1', label: 'Comida / Postre elecci√≥n', pts: 150, icon: 'üç®', type: 'Semanal' },
                { id: 'r2', label: '30 min Tecnolog√≠a extra', pts: 250, icon: 'üì±', type: 'Semanal' },
                { id: 'r3', label: 'Regalo Sorpresa Extra', pts: 800, icon: 'üéÅ', type: 'Mensual' },
                { id: 'r4', label: 'Salida o Paseo Extra', pts: 1200, icon: 'üé°', type: 'Mensual' },
                { id: 'r5', label: 'Paseo + Regalo', pts: 2000, icon: 'üíé', type: 'Mensual' }
            ],

            async init() {
                document.getElementById('display-date').innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                onAuthStateChanged(auth, (user) => {
                    if (user) { this.user = user; this.startListeners(); }
                    else { this.login(); }
                });
            },

            async login() {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            },

            startListeners() {
                const todayId = new Date().toLocaleDateString('en-CA');
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'daily', todayId), (snap) => {
                    this.data.today = snap.exists() ? (snap.data().points || {}) : {};
                    this.hideLoader();
                    this.render();
                }, (err) => console.error(err));

                onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'daily'), limit(30)), (snap) => {
                    this.data.allHistory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.render();
                }, (err) => console.error(err));
            },

            hideLoader() {
                document.getElementById('loading-overlay')?.classList.add('hidden');
                document.getElementById('content')?.classList.remove('hidden');
            },

            setTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('nav button').forEach(b => b.classList.toggle('tab-active', b.id === `tab-${tab}`));
                document.querySelectorAll('nav button').forEach(b => b.classList.toggle('opacity-50', b.id !== `tab-${tab}`));
                this.render();
            },

            async addPoint(taskId, delta, max) {
                if (!this.user) return;
                let current = Number(this.data.today[taskId] || 0);
                let newVal = current + delta;
                if (max !== null && newVal > max) newVal = max;
                if (newVal < -100) newVal = -100;

                const todayId = new Date().toLocaleDateString('en-CA');
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily', todayId), { 
                    points: { ...this.data.today, [taskId]: newVal },
                    date: todayId
                }, { merge: true });
            },

            calculateTotal() {
                return this.data.allHistory.reduce((sum, day) => {
                    return sum + Object.values(day.points || {}).reduce((a, b) => a + (Number(b) || 0), 0);
                }, 0);
            },

            render() {
                const el = document.getElementById('content');
                if (!el || el.classList.contains('hidden')) return;

                if (this.currentTab === 'daily') {
                    const totalToday = Object.values(this.data.today).reduce((a, b) => a + (Number(b) || 0), 0);
                    el.innerHTML = `
                        <div class="text-center py-6 mb-4 relative z-10">
                            <p class="text-[10px] font-black tracking-widest text-pink-500 uppercase">Puntos de Hoy</p>
                            <h2 class="text-8xl font-header italic drop-shadow-lg">${totalToday}</h2>
                        </div>
                        <div class="grid gap-3 mb-8">
                            ${this.tasks.map(t => {
                                const p = this.data.today[t.id] || 0;
                                return `
                                    <div class="glass p-4 rounded-3xl flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <span class="text-3xl drop-shadow-sm">${t.icon}</span>
                                            <div>
                                                <h4 class="font-bold text-sm uppercase italic leading-none">${t.label}</h4>
                                                <p class="text-[9px] opacity-60 font-bold mt-1 uppercase">Meta: ${t.max}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button onclick="window.App.addPoint('${t.id}', -1, ${t.max})" class="btn-press btn-minus w-10 h-10 rounded-full flex items-center justify-center font-black text-xl shadow-inner">-</button>
                                            <span class="text-2xl font-header w-6 text-center">${p}</span>
                                            <button onclick="window.App.addPoint('${t.id}', 1, ${t.max})" class="btn-press w-12 h-12 kpop-gradient rounded-full flex items-center justify-center font-black text-2xl shadow-lg border border-white/20">+</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="grid grid-cols-2 gap-4 pb-10">
                            <button onclick="window.App.addPoint('pen', -5, null)" class="btn-press glass border-red-500/30 p-4 rounded-3xl flex flex-col items-center">
                                <span class="text-[9px] font-black text-red-500 uppercase tracking-widest">Falta Grave</span>
                                <span class="text-2xl font-header">-5</span>
                            </button>
                            <button onclick="window.App.addPoint('star', 2, null)" class="btn-press glass border-yellow-500/30 p-4 rounded-3xl flex flex-col items-center">
                                <span class="text-[9px] font-black text-yellow-500 uppercase tracking-widest">Extra Star</span>
                                <span class="text-2xl font-header">+2</span>
                            </button>
                        </div>
                    `;
                } else if (this.currentTab === 'rewards') {
                    const total = this.calculateTotal();
                    el.innerHTML = `
                        <div class="glass rounded-[2.5rem] p-8 mb-8 text-center border-pink-500/30">
                            <p class="text-[10px] font-black text-pink-500 uppercase tracking-[0.3em] mb-2">Total Acumulado Gira</p>
                            <h2 class="text-7xl font-header italic">${total}</h2>
                        </div>
                        <div class="grid gap-4">
                            ${this.rewards.map(r => {
                                const prog = Math.min(100, (total / r.pts) * 100);
                                return `
                                    <div class="glass p-5 rounded-3xl flex items-center justify-between border-white/5 relative overflow-hidden">
                                        <div class="absolute top-0 left-0 h-full bg-pink-500/10" style="width: ${prog}%"></div>
                                        <div class="flex items-center gap-4 relative z-10">
                                            <span class="text-4xl drop-shadow-md">${r.icon}</span>
                                            <div>
                                                <div class="flex items-center gap-2">
                                                    <span class="text-[7px] font-black uppercase px-2 py-0.5 rounded-full ${r.type === 'Semanal' ? 'bg-blue-600' : 'bg-purple-600'} text-white">${r.type}</span>
                                                    <h4 class="font-bold text-sm uppercase italic">${r.label}</h4>
                                                </div>
                                                <p class="text-[10px] font-bold text-pink-400 mt-1">${r.pts} PTS</p>
                                            </div>
                                        </div>
                                        <div class="relative z-10 font-header ${prog >= 100 ? 'text-green-400' : 'opacity-30'} text-xl">${Math.floor(prog)}%</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    el.innerHTML = `<div class="grid gap-2">
                        ${this.data.allHistory.sort((a,b)=>b.id.localeCompare(a.id)).map(day => `
                            <div class="glass p-4 rounded-2xl flex justify-between items-center">
                                <span class="text-xs font-bold uppercase tracking-widest opacity-60">${day.id}</span>
                                <span class="font-header text-pink-500">${Object.values(day.points || {}).reduce((a,b)=>a+b,0)} PTS</span>
                            </div>
                        `).join('')}
                    </div>`;
                }
            }
        };

        window.App = App;
        App.init();
    </script>
</body>
</html>
