<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eva K-Pop Tour - Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Archivo', sans-serif; 
            background-color: #0b0b0b;
            color: white;
            margin: 0;
        }

        .font-header { font-family: 'Archivo Black', sans-serif; }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .kpop-gradient {
            background: linear-gradient(135deg, #ff0080 0%, #7928ca 100%);
        }

        .tab-active {
            border-bottom: 3px solid #ff0080;
            color: #ff0080;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #0b0b0b; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="pb-24">

    <div id="app">
        <!-- Header -->
        <header class="p-6 kpop-gradient sticky top-0 z-50 shadow-2xl">
            <div class="flex justify-between items-center max-w-4xl mx-auto">
                <div>
                    <h1 class="font-header text-2xl italic tracking-tighter uppercase">Eva World Tour</h1>
                    <p class="text-[10px] font-bold opacity-80 tracking-widest uppercase">Official Ranking System</p>
                </div>
                <div class="text-right">
                    <span id="display-date" class="text-xs font-black opacity-70">Cargando...</span>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-around bg-black/50 border-b border-white/10 sticky top-[76px] z-40 backdrop-blur-md">
            <button onclick="window.App.setTab('daily')" id="tab-daily" class="py-4 px-6 text-xs font-black uppercase tracking-widest tab-active">Hoy</button>
            <button onclick="window.App.setTab('rewards')" id="tab-rewards" class="py-4 px-6 text-xs font-black uppercase tracking-widest opacity-50">Premios</button>
            <button onclick="window.App.setTab('history')" id="tab-history" class="py-4 px-6 text-xs font-black uppercase tracking-widest opacity-50">Historial</button>
        </nav>

        <main class="p-4 max-w-4xl mx-auto">
            <!-- Loading State -->
            <div id="loading-overlay" class="py-20 text-center">
                <div class="inline-block w-8 h-8 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-xs font-bold text-white/40 tracking-widest uppercase">Validando Acceso VIP...</p>
                <div id="error-display" class="hidden mt-4 p-4 border border-red-500/50 bg-red-500/10 rounded-xl">
                    <p class="text-[10px] text-red-500 font-bold uppercase tracking-widest">Error de Permisos en la Gira</p>
                    <p class="text-[9px] text-white/60 mt-1">Verifica que las reglas de Firestore permitan escritura en la ruta de artefactos.</p>
                </div>
            </div>

            <div id="content" class="hidden">
                <!-- Secciones se inyectan aquÃ­ -->
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBE3mn9a-hgJjr3zRI_fftNfI4jfrC1lQc",
            authDomain: "eva-kpop-tour.firebaseapp.com",
            projectId: "eva-kpop-tour",
            storageBucket: "eva-kpop-tour.firebasestorage.app",
            messagingSenderId: "49327968177",
            appId: "1:49327968177:web:647c232224aa200f3c7790"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Identificador de la aplicaciÃ³n para las rutas de Firestore (Regla Estricta)
        const appId = 'eva-kpop-tour';

        const App = {
            currentTab: 'daily',
            user: null,
            data: {
                today: {},
                allHistory: []
            },
            
            tasks: [
                { id: 'dientes', label: 'Dientes', icon: 'ðŸª¥', max: 6 },
                { id: 'cama', label: 'Cama', icon: 'ðŸ›ï¸', max: 1 },
                { id: 'dormir', label: 'Dormir sola', icon: 'ðŸŒ™', max: 1 },
                { id: 'banarse', label: 'BaÃ±arse', icon: 'ðŸš¿', max: 1 },
                { id: 'leer', label: 'Leer', icon: 'ðŸ“š', max: 5 },
                { id: 'tarea', label: 'Tarea', icon: 'ðŸ“', max: 5 }
            ],

            rewards: [
                { id: 'sticker', label: 'Planilla de Stickers', pts: 50, icon: 'ðŸŒˆ' },
                { id: 'album', label: 'Ãlbum K-Pop Nuevo', pts: 350, icon: 'ðŸ’¿' },
                { id: 'concierto', label: 'Entrada Concierto', pts: 1500, icon: 'ðŸŽŸï¸' }
            ],

            async init() {
                document.getElementById('display-date').innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                
                // Paso 1: Escuchar cambios de autenticaciÃ³n
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.user = user;
                        console.log("Tour verificado:", user.uid);
                        this.startListeners();
                    } else {
                        this.doSignIn();
                    }
                });
            },

            async doSignIn() {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Fallo de acceso:", error);
                }
            },

            startListeners() {
                if (!this.user) return;
                
                const todayId = new Date().toLocaleDateString('en-CA');
                
                // IMPORTANTE: La ruta debe seguir el patrÃ³n /artifacts/{appId}/public/data/{collection}/{doc}
                const path = ['artifacts', appId, 'public', 'data', 'daily'];
                const docRef = doc(db, ...path, todayId);
                const colRef = collection(db, ...path);

                // Listener Datos de Hoy
                onSnapshot(docRef, (snap) => {
                    this.data.today = snap.exists() ? (snap.data().points || {}) : {};
                    this.hideLoader();
                    this.render();
                }, (err) => {
                    console.error("Error Permisos Hoy:", err);
                    document.getElementById('error-display').classList.remove('hidden');
                });

                // Listener Historial
                const q = query(colRef, limit(30));
                onSnapshot(q, (snap) => {
                    this.data.allHistory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.render();
                }, (err) => {
                    console.error("Error Permisos Historial:", err);
                });
            },

            hideLoader() {
                const overlay = document.getElementById('loading-overlay');
                const content = document.getElementById('content');
                if (overlay) overlay.classList.add('hidden');
                if (content) content.classList.remove('hidden');
            },

            setTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active', 'opacity-100'));
                document.querySelectorAll('nav button').forEach(btn => btn.classList.add('opacity-50'));
                const target = document.getElementById(`tab-${tab}`);
                if (target) target.classList.add('tab-active', 'opacity-100');
                this.render();
            },

            async addPoint(taskId, max) {
                if (!this.user) return;
                
                const current = this.data.today[taskId] || 0;
                if (current < max) {
                    const newPoints = { ...this.data.today, [taskId]: current + 1 };
                    const todayId = new Date().toLocaleDateString('en-CA');
                    
                    try {
                        const path = ['artifacts', appId, 'public', 'data', 'daily', todayId];
                        await setDoc(doc(db, ...path), { 
                            points: newPoints,
                            date: todayId,
                            updatedBy: this.user.uid,
                            lastSync: new Date().toISOString()
                        }, { merge: true });
                    } catch (error) {
                        console.error("Error al guardar:", error);
                    }
                }
            },

            calculateTotal(period = 'all') {
                let sum = 0;
                const now = new Date();
                
                this.data.allHistory.forEach(day => {
                    const dayDate = new Date(day.id + "T12:00:00");
                    if (isNaN(dayDate)) return;

                    let include = false;
                    if (period === 'all') include = true;
                    else if (period === 'week') {
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay());
                        if (dayDate >= startOfWeek) include = true;
                    } else if (period === 'month') {
                        if (dayDate.getMonth() === now.getMonth() && dayDate.getFullYear() === now.getFullYear()) include = true;
                    }

                    if (include && day.points) {
                        sum += Object.values(day.points).reduce((a, b) => a + (Number(b) || 0), 0);
                    }
                });
                return sum;
            },

            render() {
                const content = document.getElementById('content');
                if (!content || content.classList.contains('hidden')) return;
                
                if (this.currentTab === 'daily') this.renderDaily(content);
                else if (this.currentTab === 'rewards') this.renderRewards(content);
                else if (this.currentTab === 'history') this.renderHistory(content);
            },

            renderDaily(el) {
                const dailyTotal = Object.values(this.data.today).reduce((a, b) => a + (Number(b) || 0), 0);
                el.innerHTML = `
                    <div class="mb-8 text-center py-6">
                        <span class="text-[10px] font-black tracking-[0.3em] text-pink-500 uppercase">Puntos de Hoy</span>
                        <div class="text-8xl font-header italic">${dailyTotal}</div>
                    </div>
                    
                    <div class="grid gap-3">
                        ${this.tasks.map(t => {
                            const p = this.data.today[t.id] || 0;
                            const isMax = p >= t.max;
                            return `
                                <div onclick="window.App.addPoint('${t.id}', ${t.max})" class="glass p-4 rounded-2xl flex items-center justify-between active:scale-95 transition-transform cursor-pointer">
                                    <div class="flex items-center gap-4">
                                        <div class="text-3xl">${t.icon}</div>
                                        <div>
                                            <h4 class="font-bold uppercase italic text-sm ${isMax ? 'text-pink-500' : ''}">${t.label}</h4>
                                            <div class="flex gap-1 mt-1">
                                                ${Array(t.max).fill(0).map((_, i) => `<div class="w-1.5 h-1.5 rounded-full ${i < p ? 'bg-pink-500' : 'bg-white/10'}"></div>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-2xl font-header opacity-30">${p}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            renderRewards(el) {
                const total = this.calculateTotal('all');
                el.innerHTML = `
                    <div class="bg-pink-600/20 rounded-3xl p-6 mb-8 border border-pink-500/30">
                        <p class="text-[10px] font-bold uppercase tracking-widest text-pink-400">Total Acumulado</p>
                        <h2 class="text-5xl font-header italic">${total} <span class="text-lg not-italic opacity-50">PTS</span></h2>
                    </div>

                    <h3 class="font-header uppercase italic mb-4 text-sm tracking-widest text-white/50">Premios Disponibles</h3>
                    <div class="grid gap-4">
                        ${this.rewards.map(r => {
                            const progress = Math.min(100, (total / r.pts) * 100);
                            return `
                                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                                    <div class="absolute top-0 left-0 h-full bg-pink-500/5" style="width: ${progress}%"></div>
                                    <div class="flex justify-between items-center relative z-10">
                                        <div class="flex items-center gap-4">
                                            <div class="text-4xl">${r.icon}</div>
                                            <div>
                                                <h4 class="font-bold text-lg leading-tight">${r.label}</h4>
                                                <p class="text-xs font-bold text-pink-500">${r.pts} Puntos necesarios</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-black">${Math.floor(progress)}%</div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-white/5 h-1.5 mt-4 rounded-full overflow-hidden">
                                        <div class="h-full kpop-gradient" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            renderHistory(el) {
                const weekTotal = this.calculateTotal('week');
                const monthTotal = this.calculateTotal('month');
                const sortedHistory = [...this.data.allHistory].sort((a, b) => b.id.localeCompare(a.id));

                el.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="glass p-4 rounded-2xl">
                            <p class="text-[10px] font-bold uppercase text-white/40">Esta Semana</p>
                            <p class="text-2xl font-header italic text-pink-500">${weekTotal}</p>
                        </div>
                        <div class="glass p-4 rounded-2xl">
                            <p class="text-[10px] font-bold uppercase text-white/40">Este Mes</p>
                            <p class="text-2xl font-header italic text-purple-500">${monthTotal}</p>
                        </div>
                    </div>

                    <h3 class="font-header uppercase italic mb-4 text-sm tracking-widest text-white/50">Registro de Gira</h3>
                    <div class="space-y-2">
                        ${sortedHistory.map(day => {
                            const dayPts = day.points ? Object.values(day.points).reduce((a, b) => a + (Number(b) || 0), 0) : 0;
                            const d = new Date(day.id + "T12:00:00");
                            const dateStr = d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                            return `
                                <div class="glass px-6 py-3 rounded-xl flex justify-between items-center">
                                    <span class="text-xs font-bold uppercase tracking-tighter opacity-60">${dateStr}</span>
                                    <div class="flex items-center gap-3">
                                        <div class="h-1 w-24 bg-white/5 rounded-full overflow-hidden">
                                            <div class="h-full bg-pink-500/50" style="width: ${Math.min(100, (dayPts/20)*100)}%"></div>
                                        </div>
                                        <span class="font-header italic text-sm">${dayPts}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        };

        window.App = App;
        App.init();
    </script>
</body>
</html>
