<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EL JUEGO DE EVA KPOP - GANANCIAS CLP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@400;700;900&family=Syne:wght@800&display=swap');
        
        body { 
            font-family: 'Archivo', sans-serif; 
            background: #000;
            color: #fff;
            margin: 0;
            overflow-x: hidden;
            font-size: 1.1rem;
            background-color: #0a0a0a;
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }

        .font-header { font-family: 'Archivo Black', sans-serif; }
        .font-syne { font-family: 'Syne', sans-serif; }

        .marquee-container {
            background: #ff007f;
            overflow: hidden;
            white-space: nowrap;
            padding: 10px 0;
            border-bottom: 2px solid #fff;
            display: flex;
        }

        .marquee-text {
            display: inline-block;
            animation: marquee 22s linear infinite;
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1.32rem;
            color: #fff;
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .neon-text {
            color: #ff007f;
            text-shadow: 0 0 15px rgba(255, 0, 127, 0.6);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        .task-done {
            border-left: 4px solid #ff007f !important;
            background: rgba(255, 0, 127, 0.15) !important;
        }

        .tab-active {
            background: #fff;
            color: #000;
            font-weight: 900;
        }

        .progress-segment {
            height: 6px;
            flex: 1;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        .progress-segment.filled {
            background: #ff007f;
            box-shadow: 0 0 8px #ff007f;
        }

        .reward-card { border-left: 4px solid #facc15; }
    </style>
</head>
<body class="pb-52">

    <div class="marquee-container sticky top-0 z-50">
        <div class="marquee-text italic">
            ‚Ä¢ GANA PUNTOS ‚Ä¢ AHORRA PARA EL FUTURO ‚Ä¢ DISFRUTA TU GIRA ‚Ä¢ D√çA PERFECTO ‚Ä¢ K-POP STAR ‚Ä¢ GANA PUNTOS ‚Ä¢ AHORRA PARA EL FUTURO ‚Ä¢ DISFRUTA TU GIRA ‚Ä¢ D√çA PERFECTO ‚Ä¢ K-POP STAR ‚Ä¢
        </div>
    </div>

    <header class="p-8 text-center border-b border-white/5 bg-zinc-950/60 backdrop-blur-md">
        <h1 class="font-header text-[4.2rem] italic tracking-tighter neon-text mb-4 leading-none">EVA K-POP</h1>
        <div class="inline-block glass-card px-8 py-4 rounded-3xl">
            <span id="total-pts" class="font-header text-6xl italic">0</span>
            <p class="text-[11px] font-black text-pink-500 uppercase tracking-[0.3em] mt-2">Puntos Totales</p>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 mt-4 relative z-10">
        <nav class="flex mb-8 gap-1.5 bg-white/10 p-1 rounded-2xl border border-white/10 backdrop-blur-xl">
            <button onclick="App.setTab('tasks')" id="tab-tasks" class="flex-1 py-3 rounded-xl font-black uppercase italic text-[11px] tab-active">Misiones</button>
            <button onclick="App.setTab('rewards')" id="tab-rewards" class="flex-1 py-3 rounded-xl font-black uppercase italic text-[11px] opacity-60">Premios</button>
            <button onclick="App.setTab('history')" id="tab-history" class="flex-1 py-3 rounded-xl font-black uppercase italic text-[11px] opacity-60">Historial</button>
        </nav>

        <div id="main-content" class="space-y-3"></div>
    </main>

    <div class="fixed bottom-0 left-0 w-full p-4 bg-black/90 backdrop-blur-2xl border-t border-white/10 z-50">
        <div class="max-w-md mx-auto flex flex-col gap-3">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="App.quickAdjust(20)" class="bg-yellow-400 text-black font-black py-4 rounded-2xl uppercase text-xs italic">D√≠a Perfecto +20</button>
                <button onclick="App.quickAdjust(-5)" class="bg-zinc-800 text-white font-black py-4 rounded-2xl uppercase text-xs italic">Falta Grave -5</button>
            </div>
            <button id="btn-cloud" onclick="App.cloudSave()" class="w-full bg-pink-600/20 border border-pink-500/50 text-pink-500 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest flex items-center justify-center gap-2">
                <span id="cloud-status">‚òÅÔ∏è SINCRONIZAR NUBE</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // CONFIGURACI√ìN ROBUSTA: Intenta leer la variable o usa un objeto vac√≠o para evitar que el script muera
        const getFirebaseConfig = () => {
            try { return JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); }
            catch(e) { return {}; }
        };

        const config = getFirebaseConfig();
        const hasFirebase = config.apiKey ? true : false;
        
        let db = null, auth = null, appId = 'eva-kpop-v2';

        if (hasFirebase) {
            const app = initializeApp(config);
            db = getFirestore(app);
            auth = getAuth(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'eva-kpop-v2';
        }

        const App = {
            data: {
                total: 0,
                today: { id: '', points: {}, totalDay: 0 },
                allHistory: [],
                tab: 'tasks'
            },
            user: null,
            POINT_VALUE: 10,
            tasks: [
                { id: 'cama', label: 'Hacer la cama', pts: 1, limit: 1, icon: 'üõèÔ∏è' },
                { id: 'espacio', label: 'Mi espacio ordenado', pts: 1, limit: 1, icon: '‚ú®' },
                { id: 'dientes', label: 'Lavarse los dientes', pts: 1, limit: 6, icon: 'ü¶∑' },
                { id: 'dormir', label: 'Dormir sola', pts: 1, limit: 1, icon: 'üåô' },
                { id: 'banarse', label: 'Ba√±arse Sola', pts: 1, limit: 1, icon: 'üöø' },
                { id: 'vestirse', label: 'Vestirse Sola', pts: 1, limit: 1, icon: 'üëó' },
                { id: 'tarea', label: 'Tareas escolares', pts: 1, limit: 1, icon: 'üìö' },
                { id: 'leer', label: 'Leer', pts: 1, limit: 6, icon: 'üìñ' },
                { id: 'crear', label: 'Crear algo', pts: 1, limit: 2, icon: 'üé®' },
                { id: 'comida', label: 'Comida balanceada', pts: 1, limit: 3, icon: 'ü•ó' },
                { id: 'honesto', label: 'D√≠a honesto', pts: 5, limit: 1, icon: 'ü§ù' },
                { id: 'gritos', label: 'D√≠a sin gritos', pts: 5, limit: 1, icon: 'üîá' }
            ],
            goals: {
                weekly: [{ label: 'Pel√≠cula Extra', points: 100 }, { label: 'Helado Especial', points: 180 }],
                monthly: [{ label: 'Regalo Sorpresa', points: 400 }, { label: 'Paseo + Regalo', points: 800 }]
            },

            async init() {
                // Carga Local Inmediata (Esto asegura que los botones funcionen al instante)
                const saved = localStorage.getItem('eva_finance_kpop_v2');
                if (saved) {
                    this.data = JSON.parse(saved);
                }
                
                this.checkDay();
                this.render();

                // Intentar conexi√≥n a nube solo si hay configuraci√≥n
                if (hasFirebase) {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) await signInWithCustomToken(auth, token);
                        else await signInAnonymously(auth);

                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                this.user = user;
                                await this.cloudLoad();
                            }
                        });
                    } catch(e) { console.warn("Firebase no disponible en este entorno."); }
                } else {
                    document.getElementById('btn-cloud').style.display = 'none';
                }
            },

            checkDay() {
                const todayId = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                if (this.data.today.id !== todayId) {
                    if (this.data.today.id) this.data.allHistory.push({...this.data.today});
                    this.data.today = { id: todayId, points: {}, totalDay: 0 };
                    this.localSave();
                }
            },

            localSave() {
                localStorage.setItem('eva_finance_kpop_v2', JSON.stringify(this.data));
                this.render();
            },

            async cloudSave() {
                if (!this.user || !db) return;
                const status = document.getElementById('cloud-status');
                status.innerText = "‚è≥ GUARDANDO...";
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'scores', 'v1');
                    await setDoc(docRef, { ...this.data, lastSync: Date.now() });
                    status.innerText = "‚úÖ GUARDADO";
                    setTimeout(() => status.innerText = "‚òÅÔ∏è SINCRONIZAR NUBE", 2000);
                } catch (e) { status.innerText = "‚ùå ERROR NUBE"; }
            },

            async cloudLoad() {
                if (!this.user || !db) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'scores', 'v1');
                    const snap = await getDoc(docRef);
                    if (snap.exists()) {
                        const cloud = snap.data();
                        // Solo sobreescribir si la nube es m√°s reciente o el local est√° vac√≠o
                        this.data.total = cloud.total;
                        this.data.today = cloud.today;
                        this.data.allHistory = cloud.allHistory;
                        this.localSave();
                    }
                } catch (e) {}
            },

            adjustPoints(taskId, amount) {
                const task = this.tasks.find(t => t.id === taskId);
                const current = this.data.today.points[taskId] || 0;
                if (amount > 0 && current >= task.limit) return;
                if (amount < 0 && current <= 0) return;
                const change = amount > 0 ? 1 : -1;
                this.data.today.points[taskId] = current + change;
                this.data.today.totalDay += (change * task.pts);
                this.data.total += (change * task.pts);
                this.localSave();
            },

            quickAdjust(pts) {
                this.data.total += pts;
                this.data.today.totalDay += pts;
                this.localSave();
            },

            setTab(t) {
                this.data.tab = t;
                this.render();
            },

            render() {
                document.getElementById('total-pts').innerText = this.data.total;
                const el = document.getElementById('main-content');
                if (!el) return;
                el.innerHTML = '';

                ['tasks', 'rewards', 'history'].forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    if (btn) btn.className = `flex-1 py-3 rounded-xl font-black uppercase italic text-[11px] ${this.data.tab === t ? 'tab-active' : 'opacity-60'}`;
                });

                if (this.data.tab === 'tasks') {
                    this.tasks.forEach(t => {
                        const count = this.data.today.points[t.id] || 0;
                        const isMaxed = count >= t.limit;
                        let segs = '';
                        for(let i=0; i<t.limit; i++) segs += `<div class="progress-segment ${i<count?'filled':''}"></div>`;
                        
                        const d = document.createElement('div');
                        d.className = `glass-card p-4 rounded-2xl flex flex-col gap-4 border-l-4 ${isMaxed?'task-done border-pink-500':'border-white/10'}`;
                        d.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 glass-card rounded-lg flex items-center justify-center text-xl">${t.icon}</div>
                                    <div>
                                        <h3 class="font-bold uppercase italic text-[11px] text-white/90">${t.label}</h3>
                                        <span class="text-yellow-400 font-black text-[9px] uppercase">+${t.pts} PTS</span>
                                    </div>
                                </div>
                                <span class="text-[10px] font-black italic text-white/40">${count}/${t.limit}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex-1 flex gap-1">${segs}</div>
                                <div class="flex gap-1">
                                    <button onclick="App.adjustPoints('${t.id}', -1)" class="w-8 h-8 bg-white/5 rounded flex items-center justify-center">-</button>
                                    <button onclick="App.adjustPoints('${t.id}', 1)" class="w-8 h-8 ${isMaxed?'bg-zinc-700':'bg-pink-600'} rounded font-bold flex items-center justify-center">+</button>
                                </div>
                            </div>
                        `;
                        el.appendChild(d);
                    });
                } else if (this.data.tab === 'rewards') {
                    el.innerHTML = `<div class="p-4 glass-card rounded-3xl text-center mb-6"><p class="text-[10px] font-black opacity-40 uppercase mb-1">Presupuesto Estimado (CLP)</p><h2 class="text-3xl font-header italic neon-text">$${(this.data.total * 10).toLocaleString('es-CL')}</h2></div>`;
                    this.goals.weekly.forEach(g => {
                        const p = Math.min(100, (this.data.total / g.points) * 100);
                        el.innerHTML += `<div class="glass-card p-4 rounded-2xl mb-2 reward-card"><div class="flex justify-between text-[11px] mb-2"><b>${g.label}</b><span>${g.points} PTS</span></div><div class="w-full bg-white/10 h-1.5 rounded-full"><div class="bg-yellow-400 h-full" style="width:${p}%"></div></div></div>`;
                    });
                } else {
                    el.innerHTML = `<div class="glass-card p-4 rounded-2xl border-pink-500/50 mb-4 italic"><div class="flex justify-between"><span>HOY: ${this.data.today.id}</span><b>${this.data.today.totalDay} PTS</b></div></div>`;
                    [...this.data.allHistory].reverse().forEach(h => {
                        el.innerHTML += `<div class="glass-card p-3 rounded-xl mb-2 flex justify-between text-sm opacity-60"><span>${h.id}</span><b>${h.totalDay} PTS</b></div>`;
                    });
                }
            }
        };

        window.App = App;
        window.onload = () => App.init();
    </script>
</body>
</html>
